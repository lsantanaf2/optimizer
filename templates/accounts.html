{% extends "base.html" %}

{% block title %}Contas de AnÃºncios{% endblock %}

{% block breadcrumb %}
Contas
{% endblock %}

{% block content %}
<div class="card border-accent">
    <div class="card-title">
        ğŸ“‚ Contas de AnÃºncios
        <span class="badge badge-cyan">{{ accounts|length }} Ativas</span>
        <a href="/logout"
            style="margin-left: auto; color: var(--danger); text-decoration: none; font-size: 12px; border: 1px solid var(--danger); padding: 4px 8px; border-radius: 4px;">ğŸ”“
            Sair</a>
    </div>
    <div class="card-desc" style="display: flex; align-items: center; justify-content: space-between;">
        Selecione a conta que deseja gerenciar abaixo.
        <button onclick="consultarPortfolios()" class="btn-secondary" style="padding: 6px 12px; font-size: 11px;">ğŸ¢
            Consultar IDs de PortfÃ³lio</button>
    </div>

    <!-- BM List Container (Hidden by default) -->
    <div id="bm-container" class="card border-blue"
        style="display: none; margin-top: 16px; background: rgba(0, 163, 255, 0.05);">
        <div class="card-title" style="font-size: 14px;">ğŸ¢ Seus PortfÃ³lios Empresariais (BMs)</div>
        <div class="card-desc">Copie os IDs abaixo para o formulÃ¡rio da Meta.</div>
        <div id="bm-list" style="margin-top: 10px;">
            <div style="color: var(--text-muted); font-size: 11px;">Carregando...</div>
        </div>
    </div>

    <!-- Search Box -->
    <div style="margin-bottom: 20px;">
        <input type="text" id="account-search" placeholder="ğŸ” Buscar conta por nome ou ID..."
            style="width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--bg-deep); color: var(--text-primary); border-radius: 8px;">
    </div>

    <div class="queue-list" id="account-list">
        {% for account in accounts %}
        <a href="/conta/{{ account.account_id }}" style="text-decoration: none; color: inherit;" class="account-item"
            data-name="{{ account.name|lower }}" data-id="{{ account.account_id }}">
            <div class="queue-list-item"
                style="cursor: pointer; display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); transition: background 0.2s;">
                <div class="queue-item-number"
                    style="background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-muted); font-size: 10px; margin-right: 12px; min-width: 30px; text-align: center;">
                    ID
                </div>
                <div class="queue-item-body" style="flex: 1;">
                    <div class="queue-item-name"
                        style="background: transparent; border: none; padding: 0; font-size: 15px; font-weight: 500;">
                        {{ account.name }}
                        {% if account.business_name %}
                        <span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">ğŸ¢ {{
                            account.business_name }}</span>
                        {% endif %}
                    </div>
                    <div class="queue-item-files" style="margin-top: 4px;">
                        <span class="queue-file-tag">act_{{ account.account_id }}</span>
                        {% if account.currency %}
                        <span class="queue-file-tag"
                            style="background: var(--bg-deep); border: 1px solid var(--border);">ğŸ’° {{ account.currency
                            }}</span>
                        {% endif %}
                        <span class="config-status active">Ativa</span>
                    </div>
                </div>
                <div class="btn-queue-remove" style="border: none; color: var(--accent); font-size: 18px;">
                    âœ
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('account-search').addEventListener('input', function (e) {
        const term = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.account-item');

        items.forEach(item => {
            const name = item.getAttribute('data-name');
            const id = item.getAttribute('data-id');

            if (name.includes(term) || id.includes(term)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });

    async function consultarPortfolios() {
        const container = document.getElementById('bm-container');
        const list = document.getElementById('bm-list');

        container.style.display = 'block';
        list.innerHTML = '<div style="color: var(--text-muted); font-size: 11px;">ğŸ” Consultando API da Meta...</div>';

        try {
            const resp = await fetch('/api/businesses');
            const data = await resp.json();

            if (data.error) {
                list.innerHTML = `<div style="color: var(--danger); font-size: 11px;">âŒ Erro: ${data.error}</div>`;
                return;
            }

            if (!data.businesses || data.businesses.length === 0) {
                list.innerHTML = '<div style="color: var(--text-muted); font-size: 11px;">Nenhum portfÃ³lio encontrado.</div>';
                return;
            }

            let html = '';
            data.businesses.forEach(bm => {
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <div style="font-size: 13px; font-weight: 500;">${bm.name}</div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <code style="background: var(--bg-deep); padding: 2px 6px; border-radius: 4px; font-size: 11px; color: var(--accent);">${bm.id}</code>
                            <button onclick="navigator.clipboard.writeText('${bm.id}'); alert('ID Copiado!');" style="background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 4px; padding: 2px 4px; cursor: pointer; font-size: 10px;">ğŸ“‹</button>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;

        } catch (e) {
            list.innerHTML = `<div style="color: var(--danger); font-size: 11px;">âŒ Erro de conexÃ£o: ${e.message}</div>`;
        }
    }
</script>
{% endblock %}