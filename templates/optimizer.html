{% extends "base.html" %}

{% block title %}Otimizar ‚Äî OPTIMIZER{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('listar_contas', next='optimize') }}">Trocar Conta</a> / <span>Otimiza√ß√£o</span>
{% endblock %}

{% block content %}
<div class="card border-accent">
    <div class="card-title">
        <span>üìä Dashboard de Otimiza√ß√£o</span>
        <span class="badge badge-cyan">v1.8</span>
    </div>
    <p class="card-desc">Gerencie campanhas, conjuntos e an√∫ncios: altere verbas, pause e ative em tempo real.</p>

    <!-- Filtros -->
    <div style="display: flex; gap: 12px; align-items: flex-end;">
        <div style="flex: 1;">
            <label style="margin-top:0;">Per√≠odo de An√°lise</label>
            <select id="date-preset" onchange="loadCurrentLevel()">
                <option value="today">Hoje</option>
                <option value="yesterday">Ontem</option>
                <option value="last_7d">√öltimos 7 dias</option>
                <option value="last_30d">√öltimos 30 dias</option>
                <option value="this_month">Este M√™s</option>
                <option value="last_month">M√™s Passado</option>
                <option value="maximum">Tempo Todo</option>
            </select>
        </div>
        <button class="btn-history" onclick="loadCurrentLevel()" id="btn-refresh">üîÑ Atualizar</button>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="opt-tabs">
    <button class="opt-tab active" id="tab-campaigns" onclick="navigateTo('campaigns')">
        üìä Campanhas <span class="opt-tab-count" id="count-campaigns"></span>
    </button>
    <button class="opt-tab" id="tab-adsets" onclick="navigateTo('adsets')">
        üì¶ Conjuntos <span class="opt-tab-count" id="count-adsets"></span>
    </button>
    <button class="opt-tab" id="tab-ads" onclick="navigateTo('ads')">
        üé® An√∫ncios <span class="opt-tab-count" id="count-ads"></span>
    </button>
</div>

<!-- Breadcrumb de contexto (ex: "Conjuntos da Campanha X") -->
<div class="opt-context" id="context-bar" style="display: none;">
    <span id="context-text"></span>
    <button class="opt-context-clear" onclick="clearFilter()">‚úï Limpar filtro</button>
</div>

<!-- Selection bar -->
<div class="opt-selection-bar" id="selection-bar" style="display: none;">
    <span id="selection-count">0 selecionados</span>
    <button class="btn-action" onclick="viewChildrenOfSelected()" id="btn-view-children">
        üìÇ Ver conjuntos das selecionadas
    </button>
</div>

<!-- Data Table -->
<div class="card" style="padding: 0; overflow: hidden;">
    <div id="table-loading" class="queue-empty" style="border: none; border-radius: 0;">
        Carregando dados da Meta Ads API...
    </div>
    <div id="table-empty" class="queue-empty" style="display: none; border: none; border-radius: 0;">
        Nenhum dado encontrado para este per√≠odo.
    </div>
    <table class="opt-table" id="data-table" style="display: none;">
        <thead id="table-head">
            <!-- Injetado via JS -->
        </thead>
        <tbody id="table-body">
            <!-- Injetado via JS -->
        </tbody>
    </table>
</div>

<style>
    /* ======================== TABS ======================== */
    .opt-tabs {
        display: flex;
        gap: 0;
        margin-bottom: 0;
        border-bottom: 2px solid var(--border);
    }

    .opt-tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-family: var(--font-sans);
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }

    .opt-tab:hover {
        color: var(--text-primary);
        background: var(--bg-surface);
    }

    .opt-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
    }

    .opt-tab-count {
        font-size: 10px;
        background: var(--bg-deep);
        border: 1px solid var(--border);
        padding: 1px 8px;
        border-radius: 10px;
        margin-left: 6px;
    }

    /* ======================== CONTEXT BAR ======================== */
    .opt-context {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        background: var(--accent-glow);
        border: 1px solid var(--accent);
        border-radius: var(--radius-sm);
        margin-top: 12px;
        font-size: 13px;
        color: var(--accent);
        font-weight: 500;
    }

    .opt-context-clear {
        background: transparent;
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 3px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        font-family: var(--font-sans);
        transition: all 0.2s;
        margin-left: auto;
    }

    .opt-context-clear:hover {
        background: var(--accent);
        color: var(--bg-deep);
    }

    /* ======================== SELECTION BAR ======================== */
    .opt-selection-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 16px;
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        margin-top: 8px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* ======================== TABLE ======================== */
    .opt-table {
        width: 100%;
        border-collapse: collapse;
    }

    .opt-table thead th {
        padding: 14px 16px;
        text-align: left;
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.8px;
        font-weight: 700;
        border-bottom: 1px solid var(--border);
        background: var(--bg-surface);
        cursor: pointer;
        white-space: nowrap;
        user-select: none;
        transition: color 0.2s;
    }

    .opt-table thead th:hover {
        color: var(--accent);
    }

    .opt-table thead th.sort-asc::after {
        content: ' ‚ñ≤';
        color: var(--accent);
    }

    .opt-table thead th.sort-desc::after {
        content: ' ‚ñº';
        color: var(--accent);
    }

    .opt-table tbody tr {
        border-bottom: 1px solid var(--border-subtle);
        transition: background 0.15s;
    }

    .opt-table tbody tr:hover {
        background: var(--card-bg-hover);
    }

    .opt-table tbody td {
        padding: 12px 16px;
        font-size: 13px;
        vertical-align: middle;
    }

    /* Name cell - clickable */
    .cell-name {
        font-weight: 600;
        color: var(--text-primary);
        cursor: pointer;
        transition: color 0.2s;
    }

    .cell-name:hover {
        color: var(--accent);
        text-decoration: underline;
    }

    .cell-id {
        font-size: 10px;
        color: var(--text-muted);
        font-family: var(--font-mono);
    }

    .cell-mono {
        font-family: var(--font-mono);
        font-weight: 500;
        color: var(--accent);
        font-size: 13px;
    }

    /* Status badge */
    .status-badge {
        font-size: 10px;
        font-weight: 700;
        padding: 3px 10px;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        white-space: nowrap;
    }

    .status-badge:hover {
        opacity: 0.8;
    }

    .status-active {
        background: var(--success-bg);
        color: var(--success);
        border: 1px solid var(--success);
    }

    .status-paused {
        background: var(--danger-bg);
        color: var(--danger);
        border: 1px solid var(--danger);
    }

    /* Budget inline */
    .budget-inline {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .budget-input {
        width: 80px;
        padding: 3px 6px;
        background: var(--bg-deep);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--accent);
        font-family: var(--font-mono);
        font-size: 12px;
        text-align: right;
        transition: border-color 0.2s;
    }

    .budget-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 6px var(--accent-glow);
    }

    .btn-save-budget {
        padding: 3px 6px;
        background: var(--success-bg);
        border: 1px solid var(--success);
        border-radius: 4px;
        color: var(--success);
        font-size: 10px;
        cursor: pointer;
        transition: all 0.2s;
        display: none;
    }

    .btn-save-budget:hover {
        background: var(--success);
        color: #fff;
    }

    .btn-save-budget.visible {
        display: inline-block;
    }

    /* Checkbox */
    .opt-check {
        width: 16px;
        height: 16px;
        accent-color: var(--accent);
        cursor: pointer;
    }

    /* Spinner */
    .action-spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const ACCOUNT_ID = "{{ account_id }}";

    // ======================== STATE ========================
    let currentLevel = 'campaigns'; // 'campaigns' | 'adsets' | 'ads'
    let currentData = [];
    let selectedIds = new Set();
    let sortColumn = null;
    let sortDir = 'desc';
    // Filtro de contexto: quando clicamos no nome de uma campanha, filtramos por ela
    let filterContext = null; // { type: 'campaign', ids: [...], label: '...' } ou { type: 'adset', ... }

    const COLUMNS = {
        campaigns: [
            { key: 'check', label: '', sortable: false },
            { key: 'name', label: 'Campanha', sortable: true },
            { key: 'status', label: 'Status', sortable: true },
            { key: 'daily_budget', label: 'Verba/Dia', sortable: true },
            { key: 'spend', label: 'Gasto', sortable: true },
            { key: 'checkouts', label: 'Checkouts', sortable: true },
            { key: 'cpa_checkout', label: 'CPA Check', sortable: true },
            { key: 'compras', label: 'Compras', sortable: true },
            { key: 'cpa_compra', label: 'CAC', sortable: true },
        ],
        adsets: [
            { key: 'check', label: '', sortable: false },
            { key: 'name', label: 'Conjunto', sortable: true },
            { key: 'status', label: 'Status', sortable: true },
            { key: 'daily_budget', label: 'Verba/Dia', sortable: true },
            { key: 'spend', label: 'Gasto', sortable: true },
            { key: 'checkouts', label: 'Checkouts', sortable: true },
            { key: 'cpa_checkout', label: 'CPA Check', sortable: true },
            { key: 'compras', label: 'Compras', sortable: true },
            { key: 'cpa_compra', label: 'CAC', sortable: true },
        ],
        ads: [
            { key: 'check', label: '', sortable: false },
            { key: 'name', label: 'An√∫ncio', sortable: true },
            { key: 'status', label: 'Status', sortable: true },
            { key: 'spend', label: 'Gasto', sortable: true },
            { key: 'checkouts', label: 'Checkouts', sortable: true },
            { key: 'cpa_checkout', label: 'CPA Check', sortable: true },
            { key: 'compras', label: 'Compras', sortable: true },
            { key: 'cpa_compra', label: 'CAC', sortable: true },
        ]
    };

    function fmtBRL(val, currency = 'BRL') {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency }).format(val || 0);
    }

    function escapeHtml(text) {
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
    }

    // ======================== NAVIGATION ========================
    function navigateTo(level) {
        currentLevel = level;
        selectedIds.clear();
        updateTabsUI();

        if (level === 'campaigns') {
            filterContext = null;
        }

        loadCurrentLevel();
    }

    function updateTabsUI() {
        document.querySelectorAll('.opt-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${currentLevel}`).classList.add('active');

        // Update "ver children" button text
        const btn = document.getElementById('btn-view-children');
        if (currentLevel === 'campaigns') {
            btn.textContent = 'üì¶ Ver conjuntos das selecionadas';
        } else if (currentLevel === 'adsets') {
            btn.textContent = 'üé® Ver an√∫ncios dos selecionados';
        } else {
            btn.style.display = 'none';
        }
        if (currentLevel !== 'ads') btn.style.display = '';
    }

    function updateSelectionBar() {
        const bar = document.getElementById('selection-bar');
        const countEl = document.getElementById('selection-count');
        if (selectedIds.size > 0) {
            bar.style.display = 'flex';
            countEl.textContent = `${selectedIds.size} selecionado(s)`;
        } else {
            bar.style.display = 'none';
        }
    }

    function updateContextBar() {
        const bar = document.getElementById('context-bar');
        const text = document.getElementById('context-text');
        if (filterContext) {
            bar.style.display = 'flex';
            text.textContent = filterContext.label;
        } else {
            bar.style.display = 'none';
        }
    }

    function clearFilter() {
        filterContext = null;
        updateContextBar();
        loadCurrentLevel();
    }

    // Click no nome ‚Üí navegar para children
    function drillDown(entityId, entityName) {
        if (currentLevel === 'campaigns') {
            filterContext = { type: 'campaign', ids: [entityId], label: `üì¶ Conjuntos da campanha: "${entityName}"` };
            currentLevel = 'adsets';
        } else if (currentLevel === 'adsets') {
            filterContext = { type: 'adset', ids: [entityId], label: `üé® An√∫ncios do conjunto: "${entityName}"` };
            currentLevel = 'ads';
        }
        selectedIds.clear();
        updateTabsUI();
        updateContextBar();
        loadCurrentLevel();
    }

    // Multi-select ‚Üí ver children
    function viewChildrenOfSelected() {
        if (selectedIds.size === 0) {
            mostrarToast('‚ö†Ô∏è Selecione ao menos um item');
            return;
        }
        const ids = Array.from(selectedIds);
        const names = ids.map(id => {
            const item = currentData.find(d => d.id === id);
            return item ? item.name : id;
        });

        if (currentLevel === 'campaigns') {
            const label = names.length === 1
                ? `üì¶ Conjuntos da campanha: "${names[0]}"`
                : `üì¶ Conjuntos de ${names.length} campanhas selecionadas`;
            filterContext = { type: 'campaign', ids, label };
            currentLevel = 'adsets';
        } else if (currentLevel === 'adsets') {
            const label = names.length === 1
                ? `üé® An√∫ncios do conjunto: "${names[0]}"`
                : `üé® An√∫ncios de ${names.length} conjuntos selecionados`;
            filterContext = { type: 'adset', ids, label };
            currentLevel = 'ads';
        }
        selectedIds.clear();
        updateTabsUI();
        updateContextBar();
        loadCurrentLevel();
    }

    // ======================== DATA LOADING ========================
    async function loadCurrentLevel() {
        const loading = document.getElementById('table-loading');
        const empty = document.getElementById('table-empty');
        const table = document.getElementById('data-table');
        const btn = document.getElementById('btn-refresh');
        const preset = document.getElementById('date-preset').value;

        loading.style.display = 'block';
        empty.style.display = 'none';
        table.style.display = 'none';
        btn.disabled = true;
        btn.textContent = '‚è≥...';

        let url = '';
        if (currentLevel === 'campaigns') {
            url = `/api/account/${ACCOUNT_ID}/campaigns?date_preset=${preset}`;
        } else if (currentLevel === 'adsets') {
            const ids = filterContext?.ids?.join(',') || '';
            if (!ids) {
                // Se n√£o tem filtro, mostra todas as campanhas selecionadas ou nada
                loading.style.display = 'none';
                empty.textContent = 'Selecione ou clique em uma campanha para ver os conjuntos.';
                empty.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'üîÑ Atualizar';
                return;
            }
            url = `/api/account/${ACCOUNT_ID}/adsets?campaign_ids=${ids}&date_preset=${preset}`;
        } else if (currentLevel === 'ads') {
            const ids = filterContext?.ids?.join(',') || '';
            if (!ids) {
                loading.style.display = 'none';
                empty.textContent = 'Selecione ou clique em um conjunto para ver os an√∫ncios.';
                empty.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'üîÑ Atualizar';
                return;
            }
            url = `/api/account/${ACCOUNT_ID}/ads?adset_ids=${ids}&date_preset=${preset}`;
        }

        try {
            const r = await fetch(url);
            const res = await r.json();

            if (!res.success) throw new Error(res.error);

            currentData = res.data;

            // Update tab counts
            document.getElementById(`count-${currentLevel}`).textContent = currentData.length;

            if (currentData.length === 0) {
                loading.style.display = 'none';
                empty.textContent = 'Nenhum dado encontrado para este per√≠odo.';
                empty.style.display = 'block';
                return;
            }

            renderTable();

            loading.style.display = 'none';
            table.style.display = 'table';

        } catch (err) {
            loading.textContent = '‚ùå Erro: ' + err.message;
        } finally {
            btn.disabled = false;
            btn.textContent = 'üîÑ Atualizar';
        }
    }

    // ======================== TABLE RENDERING ========================
    function renderTable() {
        const cols = COLUMNS[currentLevel];
        const head = document.getElementById('table-head');
        const body = document.getElementById('table-body');

        // Header
        let headHTML = '<tr>';
        cols.forEach(col => {
            if (col.key === 'check') {
                headHTML += `<th style="width: 40px; text-align: center;">
                    <input type="checkbox" class="opt-check" onchange="toggleSelectAll(this.checked)">
                </th>`;
            } else {
                const sortCls = sortColumn === col.key ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                const onclick = col.sortable ? `onclick="sortBy('${col.key}')"` : '';
                headHTML += `<th class="${sortCls}" ${onclick}>${col.label}</th>`;
            }
        });
        headHTML += '</tr>';
        head.innerHTML = headHTML;

        // Sort data
        let sorted = [...currentData];
        if (sortColumn) {
            sorted.sort((a, b) => {
                let va = a[sortColumn], vb = b[sortColumn];
                if (typeof va === 'string') {
                    va = va.toLowerCase(); vb = (vb || '').toLowerCase();
                    return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
                }
                va = va || 0; vb = vb || 0;
                return sortDir === 'asc' ? va - vb : vb - va;
            });
        }

        // Body
        let bodyHTML = '';
        sorted.forEach(item => {
            const isChecked = selectedIds.has(item.id) ? 'checked' : '';
            const currency = item.currency || 'BRL';
            const entityType = currentLevel === 'campaigns' ? 'campaign' : currentLevel === 'adsets' ? 'adset' : 'ad';
            const canDrill = currentLevel !== 'ads';

            bodyHTML += '<tr>';
            cols.forEach(col => {
                switch (col.key) {
                    case 'check':
                        bodyHTML += `<td style="text-align: center;">
                            <input type="checkbox" class="opt-check" ${isChecked}
                                onchange="toggleSelect('${item.id}', this.checked)">
                        </td>`;
                        break;
                    case 'name':
                        const clickAttr = canDrill ? `onclick="drillDown('${item.id}', '${escapeHtml(item.name).replace(/'/g, "\\'")}')"` : '';
                        bodyHTML += `<td>
                            <div class="${canDrill ? 'cell-name' : ''}" ${clickAttr}>${escapeHtml(item.name)}</div>
                            <div class="cell-id">${item.id}</div>
                        </td>`;
                        break;
                    case 'status':
                        const isActive = item.status === 'ACTIVE';
                        const cls = isActive ? 'status-active' : 'status-paused';
                        const label = isActive ? 'üü¢ ATIVO' : 'üî¥ PAUSADO';
                        const newStatus = isActive ? 'PAUSED' : 'ACTIVE';
                        bodyHTML += `<td>
                            <span class="status-badge ${cls}" id="badge-${item.id}"
                                onclick="toggleStatus('${item.id}', '${entityType}', '${newStatus}')"
                                title="Clique para ${isActive ? 'pausar' : 'ativar'}">${label}</span>
                        </td>`;
                        break;
                    case 'daily_budget':
                        if (item.daily_budget !== null && item.daily_budget !== undefined) {
                            bodyHTML += `<td>
                                <div class="budget-inline">
                                    <span style="font-size:11px;color:var(--text-muted);">R$</span>
                                    <input type="number" class="budget-input" id="budget-${item.id}"
                                        value="${item.daily_budget.toFixed(2)}" step="1" min="1"
                                        onfocus="this.dataset.original=this.value"
                                        oninput="checkBudgetChange('${item.id}')">
                                    <span style="font-size:10px;color:var(--text-muted);">/dia</span>
                                    <button class="btn-save-budget" id="btn-budget-${item.id}"
                                        onclick="saveBudget('${item.id}', '${entityType}')">üíæ</button>
                                </div>
                            </td>`;
                        } else {
                            bodyHTML += `<td><span style="color:var(--text-muted);font-size:11px;">‚Äî</span></td>`;
                        }
                        break;
                    case 'spend':
                        bodyHTML += `<td class="cell-mono">${fmtBRL(item.spend, currency)}</td>`;
                        break;
                    case 'compras':
                        bodyHTML += `<td class="cell-mono">${item.compras || 0}</td>`;
                        break;
                    case 'checkouts':
                        bodyHTML += `<td class="cell-mono">${item.checkouts || 0}</td>`;
                        break;
                    case 'cpa_compra':
                        bodyHTML += `<td class="cell-mono">${item.cpa_compra > 0 ? fmtBRL(item.cpa_compra, currency) : '‚Äî'}</td>`;
                        break;
                    case 'cpa_checkout':
                        bodyHTML += `<td class="cell-mono">${item.cpa_checkout > 0 ? fmtBRL(item.cpa_checkout, currency) : '‚Äî'}</td>`;
                        break;
                }
            });
            bodyHTML += '</tr>';
        });

        body.innerHTML = bodyHTML;
    }

    // ======================== SORTING ========================
    function sortBy(column) {
        if (sortColumn === column) {
            sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDir = 'desc';
        }
        renderTable();
    }

    // ======================== SELECTION ========================
    function toggleSelect(id, checked) {
        if (checked) selectedIds.add(id);
        else selectedIds.delete(id);
        updateSelectionBar();
    }

    function toggleSelectAll(checked) {
        if (checked) {
            currentData.forEach(d => selectedIds.add(d.id));
        } else {
            selectedIds.clear();
        }
        renderTable();
        updateSelectionBar();
    }

    // ======================== ACTIONS ========================
    async function toggleStatus(entityId, entityType, newStatus) {
        const badge = document.getElementById(`badge-${entityId}`);
        if (!badge) return;

        const actionLabel = newStatus === 'PAUSED' ? 'Pausar' : 'Ativar';
        const typeLabel = entityType === 'campaign' ? 'campanha' : entityType === 'adset' ? 'conjunto' : 'an√∫ncio';
        if (!confirm(`${actionLabel} este ${typeLabel}?`)) return;

        const origHTML = badge.innerHTML;
        badge.innerHTML = '<span class="action-spinner"></span>';

        try {
            const r = await fetch(`/api/account/${ACCOUNT_ID}/entity/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ entity_id: entityId, entity_type: entityType, status: newStatus })
            });
            const res = await r.json();

            if (res.success) {
                // Update badge
                const isActive = newStatus === 'ACTIVE';
                badge.className = `status-badge ${isActive ? 'status-active' : 'status-paused'}`;
                badge.textContent = isActive ? 'üü¢ ATIVO' : 'üî¥ PAUSADO';
                const nextStatus = isActive ? 'PAUSED' : 'ACTIVE';
                badge.onclick = () => toggleStatus(entityId, entityType, nextStatus);
                badge.title = `Clique para ${isActive ? 'pausar' : 'ativar'}`;

                // Update item in currentData
                const item = currentData.find(d => d.id === entityId);
                if (item) item.status = newStatus;

                mostrarToast(`‚úÖ ${typeLabel} ${newStatus === 'ACTIVE' ? 'ativado' : 'pausado'}`);
            } else {
                badge.innerHTML = origHTML;
                mostrarToast(`‚ùå Erro: ${res.error}`);
            }
        } catch (e) {
            badge.innerHTML = origHTML;
            mostrarToast(`‚ùå Erro de rede: ${e.message}`);
        }
    }

    function checkBudgetChange(entityId) {
        const input = document.getElementById(`budget-${entityId}`);
        const btn = document.getElementById(`btn-budget-${entityId}`);
        if (input && btn) {
            btn.classList.toggle('visible', input.value !== input.dataset.original);
        }
    }

    async function saveBudget(entityId, entityType) {
        const input = document.getElementById(`budget-${entityId}`);
        const btn = document.getElementById(`btn-budget-${entityId}`);
        if (!input || !btn) return;

        const newBudget = parseFloat(input.value);
        if (isNaN(newBudget) || newBudget < 1) {
            mostrarToast('‚ùå Verba inv√°lida. M√≠nimo: R$ 1,00');
            return;
        }
        if (!confirm(`Alterar verba para R$ ${newBudget.toFixed(2)}/dia?`)) return;

        btn.innerHTML = '<span class="action-spinner"></span>';
        btn.disabled = true;

        try {
            const r = await fetch(`/api/account/${ACCOUNT_ID}/entity/budget`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ entity_id: entityId, entity_type: entityType, daily_budget: newBudget })
            });
            const res = await r.json();

            if (res.success) {
                input.dataset.original = newBudget.toFixed(2);
                btn.classList.remove('visible');
                mostrarToast(`‚úÖ Verba alterada para R$ ${newBudget.toFixed(2)}/dia`);
            } else {
                mostrarToast(`‚ùå Erro: ${res.error}`);
            }
        } catch (e) {
            mostrarToast(`‚ùå Erro de rede: ${e.message}`);
        } finally {
            btn.innerHTML = 'üíæ';
            btn.disabled = false;
        }
    }

    // ======================== INIT ========================
    document.addEventListener('DOMContentLoaded', () => {
        updateTabsUI();
        loadCurrentLevel();
    });
</script>
{% endblock %}