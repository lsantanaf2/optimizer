{% extends "base.html" %}

{% block title %}Otimizar ‚Äî OPTIMIZER{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('listar_contas', next='optimize') }}">Trocar Conta</a> / <span>Otimiza√ß√£o</span>
{% endblock %}

{% block content %}
<style>
    .container {
        max-width: 100% !important;
        padding: 0 20px !important;
        margin: 16px auto !important;
    }
</style>

<!-- Header compacto -->
<div
    style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
    <div style="display: flex; align-items: center; gap: 12px;">
        <h2 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin: 0;">üìä Otimiza√ß√£o</h2>
        <span
            style="font-size: 10px; padding: 2px 8px; border-radius: 10px; background: linear-gradient(135deg, #0891b2, #06b6d4); color: #fff; font-weight: 700;">v1.8</span>
    </div>

    <!-- Date Range Picker Trigger -->
    <div style="display: flex; align-items: center; gap: 8px;">
        <div class="drp-wrap" id="drp-wrap">
            <button class="drp-trigger" id="drp-trigger" onclick="toggleDatePicker()">
                <span class="drp-icon">üìÖ</span>
                <span id="drp-label">√öltimos 7 dias</span>
                <span class="drp-arrow">‚ñæ</span>
            </button>
            <!-- Dropdown -->
            <div class="drp-dropdown" id="drp-dropdown">
                <div class="drp-body">
                    <!-- Presets -->
                    <div class="drp-presets">
                        <div class="drp-presets-title">Per√≠odo</div>
                        <label class="drp-preset" data-preset="today"><input type="radio" name="drp" value="today">
                            Hoje</label>
                        <label class="drp-preset" data-preset="yesterday"><input type="radio" name="drp"
                                value="yesterday"> Ontem</label>
                        <label class="drp-preset" data-preset="hoje_ontem"><input type="radio" name="drp"
                                value="hoje_ontem"> Hoje e ontem</label>
                        <label class="drp-preset" data-preset="last_3d"><input type="radio" name="drp" value="last_3d">
                            √öltimos 3 dias</label>
                        <label class="drp-preset" data-preset="last_7d"><input type="radio" name="drp" value="last_7d"
                                checked> √öltimos 7 dias</label>
                        <label class="drp-preset" data-preset="last_14d"><input type="radio" name="drp"
                                value="last_14d"> √öltimos 14 dias</label>
                        <label class="drp-preset" data-preset="last_30d"><input type="radio" name="drp"
                                value="last_30d"> √öltimos 30 dias</label>
                        <label class="drp-preset" data-preset="this_month"><input type="radio" name="drp"
                                value="this_month"> Este m√™s</label>
                        <label class="drp-preset" data-preset="last_month"><input type="radio" name="drp"
                                value="last_month"> M√™s passado</label>
                        <label class="drp-preset" data-preset="maximum"><input type="radio" name="drp" value="maximum">
                            Tempo todo</label>
                        <label class="drp-preset" data-preset="custom"><input type="radio" name="drp" value="custom">
                            Personalizado</label>
                    </div>
                    <!-- Calendars + date display + buttons ‚Äî tudo integrado -->
                    <div class="drp-cal-area">
                        <div class="drp-cals">
                            <div class="drp-cal" id="drp-cal-left"></div>
                            <div class="drp-cal" id="drp-cal-right"></div>
                        </div>
                        <div class="drp-inline-footer">
                            <div class="drp-footer-dates">
                                <input type="text" class="drp-date-input" id="drp-since-display" readonly
                                    placeholder="Data inicial">
                                <span style="color:var(--text-muted);font-size:11px;">‚Üí</span>
                                <input type="text" class="drp-date-input" id="drp-until-display" readonly
                                    placeholder="Data final">
                            </div>
                            <div class="drp-footer-btns">
                                <button class="drp-btn-cancel" onclick="cancelDatePicker()">Cancelar</button>
                                <button class="drp-btn-apply" onclick="applyDatePicker()">Atualizar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn-history" onclick="loadCurrentLevel()" id="btn-refresh"
            style="padding: 6px 12px; font-size: 12px;">üîÑ</button>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="opt-tabs">
    <button class="opt-tab active" id="tab-campaigns" onclick="navigateTo('campaigns')">
        üìä Campanhas <span class="opt-tab-count" id="count-campaigns">‚Äî</span>
    </button>
    <button class="opt-tab" id="tab-adsets" onclick="navigateTo('adsets')">
        üì¶ Conjuntos <span class="opt-tab-count" id="count-adsets">‚Äî</span>
    </button>
    <button class="opt-tab" id="tab-ads" onclick="navigateTo('ads')">
        üé® An√∫ncios <span class="opt-tab-count" id="count-ads">‚Äî</span>
    </button>
</div>

<!-- Context bar -->
<div class="opt-context" id="context-bar" style="display: none;">
    <span id="context-text"></span>
    <button class="opt-context-clear" onclick="clearFilter()">‚úï Limpar filtro</button>
</div>

<!-- Selection bar -->
<div class="opt-selection-bar" id="selection-bar" style="display: none;">
    <span id="selection-count">0</span>
    <button class="btn-action" onclick="viewChildrenOfSelected()" id="btn-view-children">üìÇ Ver conjuntos</button>
</div>

<!-- Totals row -->
<div class="opt-totals" id="totals-bar" style="display: none;"></div>

<!-- Data Table -->
<div class="opt-table-wrap">
    <div id="table-loading" class="opt-empty">Carregando...</div>
    <div id="table-empty" class="opt-empty" style="display:none;">Nenhum dado com gasto para o per√≠odo selecionado.
    </div>
    <table class="opt-table" id="data-table" style="display:none;">
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
        <tfoot id="table-foot"></tfoot>
    </table>
</div>

<style>
    /* ======================== DATE RANGE PICKER ======================== */
    .drp-wrap {
        position: relative;
    }

    .drp-trigger {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 14px;
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        font-family: var(--font-sans);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        white-space: nowrap;
    }

    .drp-trigger:hover {
        border-color: var(--accent);
    }

    .drp-icon {
        font-size: 14px;
    }

    .drp-arrow {
        font-size: 10px;
        color: var(--text-muted);
    }

    .drp-dropdown {
        display: none;
        position: absolute;
        top: calc(100% + 6px);
        right: 0;
        z-index: 1000;
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        min-width: 620px;
    }

    .drp-dropdown.open {
        display: block;
    }

    .drp-body {
        display: flex;
    }

    /* Presets sidebar */
    .drp-presets {
        width: 160px;
        border-right: 1px solid var(--border);
        padding: 12px 0;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }

    .drp-presets-title {
        padding: 4px 16px 8px;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        color: var(--text-muted);
        font-weight: 700;
    }

    .drp-preset {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 16px;
        font-size: 12px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.1s;
        border: none;
        background: none;
    }

    .drp-preset:hover {
        background: var(--card-bg-hover);
        color: var(--text-primary);
    }

    .drp-preset.active {
        background: #0891b215;
        color: var(--accent);
    }

    .drp-preset input[type="radio"] {
        width: 13px;
        height: 13px;
        accent-color: var(--accent);
        margin: 0;
        cursor: pointer;
    }

    /* Calendars container */
    .drp-cals {
        display: flex;
        gap: 0;
        padding: 12px 16px;
        flex: 1;
    }

    .drp-cal {
        flex: 1;
    }

    /* Calendar header */
    .drp-cal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 4px 10px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .drp-cal-nav {
        background: none;
        border: none;
        color: var(--text-muted);
        font-size: 16px;
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 4px;
        transition: all 0.15s;
    }

    .drp-cal-nav:hover {
        background: var(--card-bg-hover);
        color: var(--text-primary);
    }

    /* Calendar grid */
    .drp-cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        text-align: center;
    }

    .drp-cal-dow {
        font-size: 10px;
        font-weight: 700;
        color: var(--text-muted);
        padding: 4px 0;
        text-transform: uppercase;
        letter-spacing: 0.4px;
    }

    .drp-cal-day {
        font-size: 12px;
        padding: 6px 2px;
        cursor: pointer;
        border-radius: 4px;
        color: var(--text-secondary);
        transition: all 0.1s;
        position: relative;
    }

    .drp-cal-day:hover {
        background: var(--card-bg-hover);
        color: var(--text-primary);
    }

    .drp-cal-day.other-month {
        color: var(--text-muted);
        opacity: 0.3;
    }

    .drp-cal-day.today {
        font-weight: 700;
        color: var(--accent);
    }

    .drp-cal-day.in-range {
        background: #0891b220;
        border-radius: 0;
        color: var(--text-primary);
    }

    .drp-cal-day.range-start {
        background: #0891b2;
        color: #fff;
        border-radius: 6px 0 0 6px;
        font-weight: 700;
    }

    .drp-cal-day.range-end {
        background: #0891b2;
        color: #fff;
        border-radius: 0 6px 6px 0;
        font-weight: 700;
    }

    .drp-cal-day.range-start.range-end {
        border-radius: 6px;
    }

    .drp-cal-day.disabled {
        opacity: 0.2;
        pointer-events: none;
    }

    /* Calendar area (cals + dates + buttons ‚Äî tudo integrado) */
    .drp-cal-area {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    /* Inline footer (dentro da cal area) */
    .drp-inline-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 16px;
        border-top: 1px solid var(--border);
    }

    .drp-footer-dates {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .drp-date-input {
        width: 120px;
        padding: 5px 8px;
        background: var(--bg-deep);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-primary);
        font-family: var(--font-sans);
        font-size: 11px;
        text-align: center;
    }

    .drp-footer-btns {
        display: flex;
        gap: 8px;
    }

    .drp-btn-cancel {
        padding: 6px 16px;
        background: var(--bg-deep);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-secondary);
        font-family: var(--font-sans);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s;
    }

    .drp-btn-cancel:hover {
        border-color: var(--text-muted);
        color: var(--text-primary);
    }

    .drp-btn-apply {
        padding: 6px 20px;
        background: #0891b2;
        border: none;
        border-radius: 4px;
        color: #fff;
        font-family: var(--font-sans);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
    }

    .drp-btn-apply:hover {
        background: #06b6d4;
    }

    /* ======================== TABS ======================== */
    .opt-tabs {
        display: flex;
        gap: 0;
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-bottom: none;
        border-radius: var(--radius-md) var(--radius-md) 0 0;
        overflow: hidden;
    }

    .opt-tab {
        flex: 1;
        padding: 10px 16px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-family: var(--font-sans);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
        text-align: center;
    }

    .opt-tab:hover {
        color: var(--text-primary);
        background: var(--card-bg-hover);
    }

    .opt-tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
        background: var(--bg-deep);
    }

    .opt-tab-count {
        font-size: 10px;
        background: var(--bg-deep);
        border: 1px solid var(--border);
        padding: 1px 7px;
        border-radius: 8px;
        margin-left: 4px;
    }

    /* ======================== CONTEXT BAR ======================== */
    .opt-context {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 14px;
        background: #00f2ff0d;
        border: 1px solid #00f2ff33;
        border-radius: 0;
        font-size: 12px;
        color: var(--accent);
        font-weight: 500;
    }

    .opt-context-clear {
        background: transparent;
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 2px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 10px;
        font-family: var(--font-sans);
        transition: all 0.2s;
        margin-left: auto;
    }

    .opt-context-clear:hover {
        background: var(--accent);
        color: var(--bg-deep);
    }

    /* ======================== SELECTION BAR ======================== */
    .opt-selection-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px 14px;
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-top: none;
        font-size: 11px;
        color: var(--text-secondary);
    }

    .opt-selection-bar .btn-action {
        padding: 3px 8px;
        font-size: 10px;
    }

    /* ======================== TABLE ======================== */
    .opt-table-wrap {
        border: 1px solid var(--border);
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        overflow: hidden;
        overflow-x: auto;
    }

    .opt-empty {
        padding: 40px;
        text-align: center;
        color: var(--text-muted);
        font-size: 13px;
        font-weight: 300;
    }

    .opt-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: auto;
        min-width: 900px;
    }

    .opt-table thead th {
        padding: 8px 12px;
        text-align: left;
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.6px;
        font-weight: 700;
        border-bottom: 2px solid var(--border);
        background: var(--bg-surface);
        cursor: pointer;
        white-space: nowrap;
        user-select: none;
        transition: color 0.15s;
        position: sticky;
        top: 0;
        z-index: 2;
    }

    .opt-table thead th:hover {
        color: var(--accent);
    }

    .opt-table thead th.sort-asc::after {
        content: ' ‚ñ≤';
        color: var(--accent);
        font-size: 9px;
    }

    .opt-table thead th.sort-desc::after {
        content: ' ‚ñº';
        color: var(--accent);
        font-size: 9px;
    }

    .opt-table tbody tr {
        border-bottom: 1px solid var(--border-subtle);
        transition: background 0.1s;
    }

    .opt-table tbody tr:nth-child(even) {
        background: #111116;
    }

    .opt-table tbody tr:nth-child(odd) {
        background: var(--card-bg);
    }

    .opt-table tbody tr:hover {
        background: #1c1c24 !important;
    }

    .opt-table tbody tr.selected-row {
        background: #00f2ff0a !important;
        border-left: 2px solid var(--accent);
    }

    .opt-table tbody td {
        padding: 7px 12px;
        font-size: 12px;
        vertical-align: middle;
        white-space: nowrap;
    }

    .opt-table tfoot td {
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 700;
        background: var(--bg-surface);
        border-top: 2px solid var(--border);
        color: var(--accent);
        font-family: var(--font-mono);
    }

    .cell-name {
        font-weight: 600;
        color: var(--text-primary);
        cursor: pointer;
        transition: color 0.15s;
        font-size: 12px;
        max-width: 280px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .cell-name:hover {
        color: var(--accent);
    }

    .cell-id {
        font-size: 9px;
        color: var(--text-muted);
        font-family: var(--font-mono);
    }

    .cell-mono {
        font-family: var(--font-mono);
        font-weight: 500;
        font-size: 12px;
        color: var(--text-primary);
    }

    .cell-zero {
        color: var(--text-muted) !important;
    }

    .status-badge {
        font-size: 9px;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 10px;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        cursor: pointer;
        transition: all 0.15s;
        border: none;
        white-space: nowrap;
    }

    .status-badge:hover {
        filter: brightness(1.2);
    }

    .status-active {
        background: #22c55e18;
        color: #22c55e;
        border: 1px solid #22c55e44;
    }

    .status-paused {
        background: #ef444418;
        color: #ef4444;
        border: 1px solid #ef444444;
    }

    .budget-inline {
        display: inline-flex;
        align-items: center;
        gap: 3px;
    }

    .budget-input {
        width: 70px;
        padding: 2px 5px;
        background: var(--bg-deep);
        border: 1px solid var(--border);
        border-radius: 3px;
        color: var(--accent);
        font-family: var(--font-mono);
        font-size: 11px;
        text-align: right;
        transition: border-color 0.15s;
    }

    .budget-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 4px var(--accent-glow);
    }

    .btn-save-budget {
        padding: 2px 5px;
        background: #22c55e18;
        border: 1px solid #22c55e;
        border-radius: 3px;
        color: #22c55e;
        font-size: 9px;
        cursor: pointer;
        transition: all 0.15s;
        display: none;
    }

    .btn-save-budget:hover {
        background: #22c55e;
        color: #fff;
    }

    .btn-save-budget.visible {
        display: inline-block;
    }

    .opt-check {
        width: 14px;
        height: 14px;
        accent-color: var(--accent);
        cursor: pointer;
    }

    .action-spinner {
        display: inline-block;
        width: 10px;
        height: 10px;
        border: 2px solid var(--border);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.5s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const ACCOUNT_ID = "{{ account_id }}";

    // ======================== DATE RANGE PICKER STATE ========================
    const MONTHS_PT = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
    const DAYS_PT = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
    const PRESET_LABELS = {
        today: 'Hoje', yesterday: 'Ontem', hoje_ontem: 'Hoje e ontem',
        last_3d: '√öltimos 3 dias', last_7d: '√öltimos 7 dias', last_14d: '√öltimos 14 dias',
        last_30d: '√öltimos 30 dias', this_month: 'Este m√™s', last_month: 'M√™s passado',
        maximum: 'Tempo todo', custom: 'Personalizado'
    };

    let drpOpen = false;
    let drpPreset = 'last_7d';
    let drpSince = null; // Date objects
    let drpUntil = null;
    let drpClickState = 0; // 0 = waiting first click, 1 = first selected, waiting second
    let drpTempSince = null; // Temp during selection
    let drpTempUntil = null;
    let drpLeftMonth = null; // { year, month(0-11) }
    let drpRightMonth = null;

    // Applied state (what's actually used for API calls)
    let appliedPreset = 'last_7d';
    let appliedSince = null;
    let appliedUntil = null;

    function todayDate() { const d = new Date(); d.setHours(0, 0, 0, 0); return d; }
    function dateStr(d) { return d.toISOString().split('T')[0]; }
    function datePT(d) { return `${d.getDate()} de ${MONTHS_PT[d.getMonth()]} de ${d.getFullYear()}`; }
    function dateShortPT(d) { return `${d.getDate()} de ${MONTHS_PT[d.getMonth()]}...`; }
    function sameDay(a, b) { return a && b && dateStr(a) === dateStr(b); }
    function daysBetween(a, b) { return Math.floor((b - a) / 86400000); }

    function presetToDates(preset) {
        const today = todayDate();
        let s, u;
        switch (preset) {
            case 'today': s = u = new Date(today); break;
            case 'yesterday': s = u = new Date(today - 86400000); break;
            case 'hoje_ontem': s = new Date(today - 86400000); u = new Date(today); break;
            case 'last_3d': s = new Date(today - 2 * 86400000); u = new Date(today); break;
            case 'last_7d': s = new Date(today - 6 * 86400000); u = new Date(today); break;
            case 'last_14d': s = new Date(today - 13 * 86400000); u = new Date(today); break;
            case 'last_30d': s = new Date(today - 29 * 86400000); u = new Date(today); break;
            case 'this_month': s = new Date(today.getFullYear(), today.getMonth(), 1); u = new Date(today); break;
            case 'last_month':
                s = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                u = new Date(today.getFullYear(), today.getMonth(), 0); break;
            default: s = new Date(today - 6 * 86400000); u = new Date(today);
        }
        return { since: s, until: u };
    }

    function initDRP() {
        const { since, until } = presetToDates('last_7d');
        drpSince = drpTempSince = appliedSince = since;
        drpUntil = drpTempUntil = appliedUntil = until;
        const today = todayDate();
        drpLeftMonth = { year: today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear(), month: today.getMonth() === 0 ? 11 : today.getMonth() - 1 };
        drpRightMonth = { year: today.getFullYear(), month: today.getMonth() };
        updateTriggerLabel();
    }

    function updateTriggerLabel() {
        const label = document.getElementById('drp-label');
        if (appliedPreset !== 'custom' && appliedPreset !== 'maximum') {
            // Show friendly name + date range
            const { since, until } = presetToDates(appliedPreset);
            if (sameDay(since, until)) {
                label.textContent = `${datePT(since)}`;
            } else {
                label.textContent = `${datePT(since)} a ${datePT(until)}`;
            }
        } else if (appliedPreset === 'maximum') {
            label.textContent = 'Tempo todo';
        } else {
            label.textContent = `${datePT(appliedSince)} a ${datePT(appliedUntil)}`;
        }
    }

    function toggleDatePicker() {
        drpOpen = !drpOpen;
        document.getElementById('drp-dropdown').classList.toggle('open', drpOpen);
        if (drpOpen) {
            // Reset temp state to applied
            drpPreset = appliedPreset;
            drpTempSince = appliedSince ? new Date(appliedSince) : null;
            drpTempUntil = appliedUntil ? new Date(appliedUntil) : null;
            drpClickState = 0;
            highlightPreset();
            renderCalendars();
            updateFooterDates();
        }
    }

    function cancelDatePicker() {
        drpOpen = false;
        document.getElementById('drp-dropdown').classList.remove('open');
    }

    function applyDatePicker() {
        appliedPreset = drpPreset;
        if (drpPreset === 'custom') {
            if (!drpTempSince || !drpTempUntil) { mostrarToast('‚ö†Ô∏è Selecione as datas'); return; }
            appliedSince = new Date(drpTempSince);
            appliedUntil = new Date(drpTempUntil);
        } else if (drpPreset === 'maximum') {
            appliedSince = null;
            appliedUntil = null;
        } else {
            const { since, until } = presetToDates(drpPreset);
            appliedSince = since;
            appliedUntil = until;
        }
        drpOpen = false;
        document.getElementById('drp-dropdown').classList.remove('open');
        updateTriggerLabel();
        loadCurrentLevel();
    }

    function highlightPreset() {
        document.querySelectorAll('.drp-preset').forEach(el => {
            const val = el.dataset.preset;
            el.classList.toggle('active', val === drpPreset);
            el.querySelector('input').checked = val === drpPreset;
        });
    }

    // Preset click handler
    document.addEventListener('click', (e) => {
        const preset = e.target.closest('.drp-preset');
        if (preset) {
            const val = preset.dataset.preset;
            drpPreset = val;
            highlightPreset();
            if (val !== 'custom' && val !== 'maximum') {
                const { since, until } = presetToDates(val);
                drpTempSince = since;
                drpTempUntil = until;
                drpClickState = 0;
                // Navigate calendar to show the range
                drpLeftMonth = { year: since.getFullYear(), month: since.getMonth() };
                const nextM = since.getMonth() + 1;
                drpRightMonth = { year: nextM > 11 ? since.getFullYear() + 1 : since.getFullYear(), month: nextM > 11 ? 0 : nextM };
                // If until is in a later month, adjust
                if (until.getFullYear() > drpRightMonth.year || (until.getFullYear() === drpRightMonth.year && until.getMonth() > drpRightMonth.month)) {
                    drpRightMonth = { year: until.getFullYear(), month: until.getMonth() };
                    const prevM = until.getMonth() - 1;
                    drpLeftMonth = { year: prevM < 0 ? until.getFullYear() - 1 : until.getFullYear(), month: prevM < 0 ? 11 : prevM };
                }
            } else if (val === 'maximum') {
                drpTempSince = null; drpTempUntil = null; drpClickState = 0;
            } else {
                drpClickState = 0; // custom: user will click on calendar
            }
            renderCalendars();
            updateFooterDates();
        }

        // Close on click outside
        if (drpOpen && !e.target.closest('.drp-wrap')) {
            cancelDatePicker();
        }
    });

    function updateFooterDates() {
        document.getElementById('drp-since-display').value = drpTempSince ? datePT(drpTempSince) : '';
        document.getElementById('drp-until-display').value = drpTempUntil ? datePT(drpTempUntil) : '';
    }

    // ======================== CALENDAR RENDERING ========================
    function renderCalendars() {
        renderOneCalendar('drp-cal-left', drpLeftMonth, 'left');
        renderOneCalendar('drp-cal-right', drpRightMonth, 'right');
    }

    function renderOneCalendar(containerId, monthObj, side) {
        const container = document.getElementById(containerId);
        const { year, month } = monthObj;
        const today = todayDate();

        // Header
        const monthName = MONTHS_PT[month];
        let html = `<div class="drp-cal-header">`;
        if (side === 'left') {
            html += `<button class="drp-cal-nav" onclick="navMonth(-1)">‚Äπ</button>`;
        } else {
            html += `<span></span>`;
        }
        html += `<span>${monthName} ${year}</span>`;
        if (side === 'right') {
            html += `<button class="drp-cal-nav" onclick="navMonth(1)">‚Ä∫</button>`;
        } else {
            html += `<span></span>`;
        }
        html += `</div>`;

        // DOW header
        html += `<div class="drp-cal-grid">`;
        DAYS_PT.forEach(d => { html += `<div class="drp-cal-dow">${d}</div>`; });

        // Days
        const firstDay = new Date(year, month, 1);
        let startDow = firstDay.getDay(); // 0=Sun
        startDow = startDow === 0 ? 6 : startDow - 1; // Convert to Mon=0
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Previous month fill
        const prevDays = new Date(year, month, 0).getDate();
        for (let i = startDow - 1; i >= 0; i--) {
            html += `<div class="drp-cal-day other-month">${prevDays - i}</div>`;
        }

        // Current month
        for (let d = 1; d <= daysInMonth; d++) {
            const thisDate = new Date(year, month, d);
            const classes = ['drp-cal-day'];

            // Today
            if (sameDay(thisDate, today)) classes.push('today');

            // Future dates disabled
            if (thisDate > today) classes.push('disabled');

            // Range highlighting
            if (drpTempSince && drpTempUntil) {
                if (sameDay(thisDate, drpTempSince)) classes.push('range-start');
                if (sameDay(thisDate, drpTempUntil)) classes.push('range-end');
                if (thisDate > drpTempSince && thisDate < drpTempUntil) classes.push('in-range');
            } else if (drpTempSince && sameDay(thisDate, drpTempSince)) {
                classes.push('range-start', 'range-end');
            }

            const ds = dateStr(thisDate);
            html += `<div class="${classes.join(' ')}" onclick="event.stopPropagation(); onDayClick('${ds}')">${d}</div>`;
        }

        // Next month fill
        const totalCells = startDow + daysInMonth;
        const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let i = 1; i <= remaining; i++) {
            html += `<div class="drp-cal-day other-month">${i}</div>`;
        }

        html += `</div>`;
        container.innerHTML = html;
    }

    function navMonth(dir) {
        // Move both months
        drpLeftMonth.month += dir;
        if (drpLeftMonth.month < 0) { drpLeftMonth.month = 11; drpLeftMonth.year--; }
        if (drpLeftMonth.month > 11) { drpLeftMonth.month = 0; drpLeftMonth.year++; }

        drpRightMonth.month += dir;
        if (drpRightMonth.month < 0) { drpRightMonth.month = 11; drpRightMonth.year--; }
        if (drpRightMonth.month > 11) { drpRightMonth.month = 0; drpRightMonth.year++; }

        renderCalendars();
    }

    function onDayClick(dateString) {
        const clicked = new Date(dateString + 'T00:00:00');
        drpPreset = 'custom';
        highlightPreset();

        if (drpClickState === 0) {
            // First click ‚Äî set start
            drpTempSince = clicked;
            drpTempUntil = null;
            drpClickState = 1;
        } else {
            // Second click ‚Äî set end
            if (clicked < drpTempSince) {
                // Clicked before start ‚Äî swap
                drpTempUntil = new Date(drpTempSince);
                drpTempSince = clicked;
            } else {
                drpTempUntil = clicked;
            }
            drpClickState = 0;
        }

        renderCalendars();
        updateFooterDates();
    }

    // ======================== API DATE PARAMS ========================
    function getDateParams() {
        if (appliedPreset === 'maximum') return 'date_preset=maximum';
        if (appliedPreset === 'custom' || appliedPreset === 'hoje_ontem' || appliedPreset === 'last_3d' || appliedPreset === 'last_14d') {
            // These don't have a direct Meta API date_preset equivalent, use since/until
            if (appliedSince && appliedUntil) return `since=${dateStr(appliedSince)}&until=${dateStr(appliedUntil)}`;
            return 'date_preset=last_7d';
        }
        // Direct Meta presets
        return `date_preset=${appliedPreset}`;
    }

    // ======================== STATE ========================
    let currentLevel = 'campaigns';
    let currentData = [];
    let selectedIds = new Set();
    let sortColumn = 'spend';
    let sortDir = 'desc';
    let filterContext = null;
    let lastCheckedIndex = -1;

    const COLUMNS = {
        campaigns: [
            { key: 'check', label: '', sortable: false, w: '30px' },
            { key: 'name', label: 'Campanha', sortable: true },
            { key: 'status', label: 'Status', sortable: true, w: '80px' },
            { key: 'daily_budget', label: 'Verba/Dia', sortable: true, w: '110px' },
            { key: 'spend', label: 'Gasto', sortable: true, w: '100px' },
            { key: 'checkouts', label: 'Fin. Compra', sortable: true, w: '80px' },
            { key: 'cpa_checkout', label: 'Custo/Fin.', sortable: true, w: '90px' },
            { key: 'compras', label: 'Compras', sortable: true, w: '70px' },
            { key: 'cpa_compra', label: 'CAC', sortable: true, w: '90px' },
        ],
        adsets: [
            { key: 'check', label: '', sortable: false, w: '30px' },
            { key: 'name', label: 'Conjunto de An√∫ncios', sortable: true },
            { key: 'status', label: 'Status', sortable: true, w: '80px' },
            { key: 'daily_budget', label: 'Verba/Dia', sortable: true, w: '110px' },
            { key: 'spend', label: 'Gasto', sortable: true, w: '100px' },
            { key: 'checkouts', label: 'Fin. Compra', sortable: true, w: '80px' },
            { key: 'cpa_checkout', label: 'Custo/Fin.', sortable: true, w: '90px' },
            { key: 'compras', label: 'Compras', sortable: true, w: '70px' },
            { key: 'cpa_compra', label: 'CAC', sortable: true, w: '90px' },
        ],
        ads: [
            { key: 'check', label: '', sortable: false, w: '30px' },
            { key: 'name', label: 'An√∫ncio', sortable: true },
            { key: 'status', label: 'Status', sortable: true, w: '80px' },
            { key: 'spend', label: 'Gasto', sortable: true, w: '100px' },
            { key: 'checkouts', label: 'Fin. Compra', sortable: true, w: '80px' },
            { key: 'cpa_checkout', label: 'Custo/Fin.', sortable: true, w: '90px' },
            { key: 'compras', label: 'Compras', sortable: true, w: '70px' },
            { key: 'cpa_compra', label: 'CAC', sortable: true, w: '90px' },
        ]
    };

    function fmtBRL(val, currency = 'BRL') { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency }).format(val || 0); }
    function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    // ======================== NAVIGATION ========================
    function navigateTo(level) {
        currentLevel = level;
        selectedIds.clear();
        lastCheckedIndex = -1;
        updateTabsUI();
        if (level === 'campaigns') filterContext = null;
        loadCurrentLevel();
    }

    function updateTabsUI() {
        document.querySelectorAll('.opt-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${currentLevel}`).classList.add('active');
        const btn = document.getElementById('btn-view-children');
        if (currentLevel === 'campaigns') btn.textContent = 'üì¶ Ver conjuntos';
        else if (currentLevel === 'adsets') btn.textContent = 'üé® Ver an√∫ncios';
        btn.style.display = currentLevel === 'ads' ? 'none' : '';
    }

    function updateSelectionBar() {
        const bar = document.getElementById('selection-bar');
        const cnt = document.getElementById('selection-count');
        if (selectedIds.size > 0) { bar.style.display = 'flex'; cnt.textContent = `${selectedIds.size} selecionado(s)`; }
        else bar.style.display = 'none';
        document.querySelectorAll('#table-body tr').forEach(tr => {
            tr.classList.toggle('selected-row', selectedIds.has(tr.dataset.id));
        });
    }

    function updateContextBar() {
        const bar = document.getElementById('context-bar'), text = document.getElementById('context-text');
        if (filterContext) { bar.style.display = 'flex'; text.textContent = filterContext.label; }
        else bar.style.display = 'none';
    }

    function clearFilter() { filterContext = null; updateContextBar(); loadCurrentLevel(); }

    function drillDown(entityId, entityName) {
        if (currentLevel === 'campaigns') {
            filterContext = { type: 'campaign', ids: [entityId], label: `üì¶ Conjuntos da campanha: "${entityName}"` };
            currentLevel = 'adsets';
        } else if (currentLevel === 'adsets') {
            filterContext = { type: 'adset', ids: [entityId], label: `üé® An√∫ncios do conjunto: "${entityName}"` };
            currentLevel = 'ads';
        }
        selectedIds.clear(); lastCheckedIndex = -1;
        updateTabsUI(); updateContextBar(); loadCurrentLevel();
    }

    function viewChildrenOfSelected() {
        if (selectedIds.size === 0) { mostrarToast('‚ö†Ô∏è Selecione ao menos um item'); return; }
        const ids = Array.from(selectedIds);
        const names = ids.map(id => { const i = currentData.find(d => d.id === id); return i ? i.name : id; });
        if (currentLevel === 'campaigns') {
            filterContext = { type: 'campaign', ids, label: names.length === 1 ? `üì¶ Conjuntos: "${names[0]}"` : `üì¶ Conjuntos de ${names.length} campanhas` };
            currentLevel = 'adsets';
        } else if (currentLevel === 'adsets') {
            filterContext = { type: 'adset', ids, label: names.length === 1 ? `üé® An√∫ncios: "${names[0]}"` : `üé® An√∫ncios de ${names.length} conjuntos` };
            currentLevel = 'ads';
        }
        selectedIds.clear(); lastCheckedIndex = -1;
        updateTabsUI(); updateContextBar(); loadCurrentLevel();
    }

    // ======================== DATA LOADING ========================
    async function loadCurrentLevel() {
        const loading = document.getElementById('table-loading'), empty = document.getElementById('table-empty'),
            table = document.getElementById('data-table'), btn = document.getElementById('btn-refresh');
        const dp = getDateParams();

        loading.style.display = 'block'; empty.style.display = 'none'; table.style.display = 'none';
        document.getElementById('totals-bar').style.display = 'none';
        btn.disabled = true; btn.textContent = '‚è≥';

        let url = '';
        if (currentLevel === 'campaigns') {
            url = `/api/account/${ACCOUNT_ID}/campaigns?${dp}`;
        } else if (currentLevel === 'adsets') {
            const ids = filterContext?.ids?.join(',') || '';
            if (!ids) { loading.style.display = 'none'; empty.textContent = 'Selecione ou clique em uma campanha.'; empty.style.display = 'block'; btn.disabled = false; btn.textContent = 'üîÑ'; return; }
            url = `/api/account/${ACCOUNT_ID}/adsets?campaign_ids=${ids}&${dp}`;
        } else if (currentLevel === 'ads') {
            const ids = filterContext?.ids?.join(',') || '';
            if (!ids) { loading.style.display = 'none'; empty.textContent = 'Selecione ou clique em um conjunto.'; empty.style.display = 'block'; btn.disabled = false; btn.textContent = 'üîÑ'; return; }
            url = `/api/account/${ACCOUNT_ID}/ads?adset_ids=${ids}&${dp}`;
        }

        try {
            const r = await fetch(url); const res = await r.json();
            if (!res.success) throw new Error(res.error);
            currentData = res.data;
            document.getElementById(`count-${currentLevel}`).textContent = currentData.length;

            if (currentData.length === 0) { loading.style.display = 'none'; empty.textContent = 'Nenhum dado com gasto no per√≠odo selecionado.'; empty.style.display = 'block'; return; }
            renderTable();
            loading.style.display = 'none'; table.style.display = 'table';
        } catch (err) { loading.textContent = '‚ùå ' + err.message; }
        finally { btn.disabled = false; btn.textContent = 'üîÑ'; }
    }

    // ======================== TABLE RENDERING ========================
    function renderTable() {
        const cols = COLUMNS[currentLevel];
        const head = document.getElementById('table-head');
        const body = document.getElementById('table-body');
        const foot = document.getElementById('table-foot');

        let h = '<tr>';
        cols.forEach(c => {
            if (c.key === 'check') {
                h += `<th style="width:${c.w};text-align:center;"><input type="checkbox" class="opt-check" onchange="toggleSelectAll(this.checked)"></th>`;
            } else {
                const sc = sortColumn === c.key ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                const oc = c.sortable ? `onclick="sortBy('${c.key}')"` : '';
                const w = c.w ? `style="width:${c.w}"` : '';
                h += `<th class="${sc}" ${oc} ${w}>${c.label}</th>`;
            }
        });
        h += '</tr>'; head.innerHTML = h;

        let sorted = [...currentData];
        if (sortColumn) {
            sorted.sort((a, b) => {
                let va = a[sortColumn], vb = b[sortColumn];
                if (typeof va === 'string') { va = (va || '').toLowerCase(); vb = (vb || '').toLowerCase(); return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va); }
                va = va || 0; vb = vb || 0; return sortDir === 'asc' ? va - vb : vb - va;
            });
        }

        let b = '';
        const entityType = currentLevel === 'campaigns' ? 'campaign' : currentLevel === 'adsets' ? 'adset' : 'ad';
        const canDrill = currentLevel !== 'ads';

        sorted.forEach((item, idx) => {
            const chk = selectedIds.has(item.id) ? 'checked' : '';
            const cur = item.currency || 'BRL';
            const selCls = selectedIds.has(item.id) ? 'selected-row' : '';

            b += `<tr class="${selCls}" data-id="${item.id}">`;
            cols.forEach(c => {
                switch (c.key) {
                    case 'check':
                        b += `<td style="text-align:center;"><input type="checkbox" class="opt-check" data-idx="${idx}" ${chk}
                        onclick="handleCheckClick(event, '${item.id}', ${idx})"></td>`; break;
                    case 'name':
                        const click = canDrill ? `onclick="drillDown('${item.id}','${escapeHtml(item.name).replace(/'/g, "\\'")}')"` : '';
                        b += `<td><div class="${canDrill ? 'cell-name' : ''}" ${click} title="${escapeHtml(item.name)}">${escapeHtml(item.name)}</div><div class="cell-id">${item.id}</div></td>`; break;
                    case 'status':
                        const isA = item.status === 'ACTIVE'; const cls = isA ? 'status-active' : 'status-paused'; const lbl = isA ? 'Ativo' : 'Pausado';
                        const ns = isA ? 'PAUSED' : 'ACTIVE';
                        b += `<td><span class="status-badge ${cls}" id="badge-${item.id}" onclick="toggleStatus('${item.id}','${entityType}','${ns}')" title="Clique para ${isA ? 'pausar' : 'ativar'}">${lbl}</span></td>`; break;
                    case 'daily_budget':
                        if (item.daily_budget != null) {
                            b += `<td><div class="budget-inline"><span style="font-size:10px;color:var(--text-muted)">R$</span>
                            <input type="number" class="budget-input" id="budget-${item.id}" value="${item.daily_budget.toFixed(2)}" step="1" min="1"
                            onfocus="this.dataset.original=this.value" oninput="checkBudgetChange('${item.id}')">
                            <button class="btn-save-budget" id="btn-budget-${item.id}" onclick="saveBudget('${item.id}','${entityType}')">üíæ</button></div></td>`;
                        } else { b += `<td><span style="color:var(--text-muted);font-size:10px">‚Äî</span></td>`; } break;
                    case 'spend':
                        b += `<td class="cell-mono ${item.spend == 0 ? 'cell-zero' : ''}">${fmtBRL(item.spend, cur)}</td>`; break;
                    case 'compras':
                        b += `<td class="cell-mono ${item.compras == 0 ? 'cell-zero' : ''}">${item.compras || 0}</td>`; break;
                    case 'checkouts':
                        b += `<td class="cell-mono ${item.checkouts == 0 ? 'cell-zero' : ''}">${item.checkouts || 0}</td>`; break;
                    case 'cpa_compra':
                        b += `<td class="cell-mono ${!item.cpa_compra ? 'cell-zero' : ''}">${item.cpa_compra > 0 ? fmtBRL(item.cpa_compra, cur) : '‚Äî'}</td>`; break;
                    case 'cpa_checkout':
                        b += `<td class="cell-mono ${!item.cpa_checkout ? 'cell-zero' : ''}">${item.cpa_checkout > 0 ? fmtBRL(item.cpa_checkout, cur) : '‚Äî'}</td>`; break;
                }
            });
            b += '</tr>';
        });
        body.innerHTML = b;

        // Footer totals
        const totalSpend = currentData.reduce((s, i) => s + (i.spend || 0), 0);
        const totalCompras = currentData.reduce((s, i) => s + (i.compras || 0), 0);
        const totalCheckouts = currentData.reduce((s, i) => s + (i.checkouts || 0), 0);
        const cur = currentData[0]?.currency || 'BRL';

        let f = '<tr>';
        cols.forEach(c => {
            switch (c.key) {
                case 'check': f += `<td></td>`; break;
                case 'name': f += `<td style="color:var(--text-primary)">Total: ${currentData.length} resultados</td>`; break;
                case 'spend': f += `<td>${fmtBRL(totalSpend, cur)}</td>`; break;
                case 'compras': f += `<td>${totalCompras}</td>`; break;
                case 'checkouts': f += `<td>${totalCheckouts}</td>`; break;
                case 'cpa_compra': f += `<td>${totalCompras > 0 ? fmtBRL(totalSpend / totalCompras, cur) : '‚Äî'}</td>`; break;
                case 'cpa_checkout': f += `<td>${totalCheckouts > 0 ? fmtBRL(totalSpend / totalCheckouts, cur) : '‚Äî'}</td>`; break;
                default: f += `<td></td>`; break;
            }
        });
        f += '</tr>'; foot.innerHTML = f;
    }

    // ======================== SORTING ========================
    function sortBy(col) {
        if (sortColumn === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        else { sortColumn = col; sortDir = 'desc'; }
        renderTable();
    }

    // ======================== SELECTION with SHIFT+CLICK ========================
    function handleCheckClick(event, id, idx) {
        const checked = event.target.checked;
        if (event.shiftKey && lastCheckedIndex >= 0) {
            const start = Math.min(lastCheckedIndex, idx);
            const end = Math.max(lastCheckedIndex, idx);
            const sorted = getSortedData();
            for (let i = start; i <= end; i++) {
                if (sorted[i]) {
                    if (checked) selectedIds.add(sorted[i].id);
                    else selectedIds.delete(sorted[i].id);
                }
            }
            renderTable();
        } else {
            if (checked) selectedIds.add(id);
            else selectedIds.delete(id);
        }
        lastCheckedIndex = idx;
        updateSelectionBar();
    }

    function getSortedData() {
        let sorted = [...currentData];
        if (sortColumn) {
            sorted.sort((a, b) => {
                let va = a[sortColumn], vb = b[sortColumn];
                if (typeof va === 'string') { va = (va || '').toLowerCase(); vb = (vb || '').toLowerCase(); return sortDir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va); }
                va = va || 0; vb = vb || 0; return sortDir === 'asc' ? va - vb : vb - va;
            });
        }
        return sorted;
    }

    function toggleSelectAll(checked) {
        if (checked) currentData.forEach(d => selectedIds.add(d.id)); else selectedIds.clear();
        lastCheckedIndex = -1;
        renderTable(); updateSelectionBar();
    }

    // ======================== ACTIONS ========================
    async function toggleStatus(entityId, entityType, newStatus) {
        const badge = document.getElementById(`badge-${entityId}`);
        if (!badge) return;
        const typeLabel = entityType === 'campaign' ? 'campanha' : entityType === 'adset' ? 'conjunto' : 'an√∫ncio';
        if (!confirm(`${newStatus === 'PAUSED' ? 'Pausar' : 'Ativar'} ${typeLabel}?`)) return;

        const orig = badge.innerHTML; badge.innerHTML = '<span class="action-spinner"></span>';
        try {
            const r = await fetch(`/api/account/${ACCOUNT_ID}/entity/status`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ entity_id: entityId, entity_type: entityType, status: newStatus }) });
            const res = await r.json();
            if (res.success) {
                const isA = newStatus === 'ACTIVE';
                badge.className = `status-badge ${isA ? 'status-active' : 'status-paused'}`;
                badge.textContent = isA ? 'Ativo' : 'Pausado';
                const next = isA ? 'PAUSED' : 'ACTIVE';
                badge.onclick = () => toggleStatus(entityId, entityType, next);
                badge.title = `Clique para ${isA ? 'pausar' : 'ativar'}`;
                const item = currentData.find(d => d.id === entityId); if (item) item.status = newStatus;
                mostrarToast(`‚úÖ ${typeLabel} ${isA ? 'ativado' : 'pausado'}`);
            } else { badge.innerHTML = orig; mostrarToast(`‚ùå ${res.error}`); }
        } catch (e) { badge.innerHTML = orig; mostrarToast(`‚ùå ${e.message}`); }
    }

    function checkBudgetChange(id) {
        const inp = document.getElementById(`budget-${id}`), btn = document.getElementById(`btn-budget-${id}`);
        if (inp && btn) btn.classList.toggle('visible', inp.value !== inp.dataset.original);
    }

    async function saveBudget(entityId, entityType) {
        const inp = document.getElementById(`budget-${entityId}`), btn = document.getElementById(`btn-budget-${entityId}`);
        if (!inp || !btn) return;
        const v = parseFloat(inp.value);
        if (isNaN(v) || v < 1) { mostrarToast('‚ùå M√≠nimo R$ 1,00'); return; }
        if (!confirm(`Alterar verba para R$ ${v.toFixed(2)}/dia?`)) return;
        btn.innerHTML = '<span class="action-spinner"></span>'; btn.disabled = true;
        try {
            const r = await fetch(`/api/account/${ACCOUNT_ID}/entity/budget`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ entity_id: entityId, entity_type: entityType, daily_budget: v }) });
            const res = await r.json();
            if (res.success) { inp.dataset.original = v.toFixed(2); btn.classList.remove('visible'); mostrarToast(`‚úÖ Verba: R$ ${v.toFixed(2)}/dia`); }
            else mostrarToast(`‚ùå ${res.error}`);
        } catch (e) { mostrarToast(`‚ùå ${e.message}`); }
        finally { btn.innerHTML = 'üíæ'; btn.disabled = false; }
    }

    // ======================== INIT ========================
    document.addEventListener('DOMContentLoaded', () => {
        initDRP();
        updateTabsUI();
        loadCurrentLevel();
    });
</script>
{% endblock %}