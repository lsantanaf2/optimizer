<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup de An√∫ncios ‚Äî {{ campaign_name }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>

    <div class="topbar">
        <h1>‚ö° OPTIMIZER</h1>
        <div class="breadcrumb">
            <a href="/">Contas</a> ‚Üí <a href="/conta/{{ account_id }}">Campanhas</a> ‚Üí Setup
        </div>
    </div>

    <!-- Datalists -->
    <datalist id="dl-urls"></datalist>
    <datalist id="dl-utms"></datalist>
    <datalist id="dl-textos"></datalist>
    <datalist id="dl-titulos"></datalist>

    <div class="container">

        <!-- Header -->
        <div class="card border-accent">
            <div class="card-title">üéØ {{ campaign_name }}</div>
            <div class="card-desc">ID: {{ campaign_id }} ¬∑ Preencha as configura√ß√µes globais uma vez, depois adicione as
                m√≠dias rapidamente.</div>
        </div>

        <!-- ================================================================ -->
        <!--  SE√á√ÉO 0: IDENTIDADE E RASTREAMENTO                              -->
        <!-- ================================================================ -->
        <div class="card border-blue">
            <div class="card-title">0. Identidade e Rastreamento <span class="badge badge-blue">OBRIGAT√ìRIO</span></div>
            <div class="card-desc">Defina quem est√° publicando e como rastrear os resultados.</div>

            <div class="form-row" style="display: flex; gap: 16px;">
                <div class="form-group" style="flex: 1;">
                    <label>P√°gina do Facebook</label>
                    <select id="select-page" style="width: 100%;">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Conta do Instagram (Opcional)</label>
                    <select id="select-instagram" style="width: 100%;">
                        <option value="">‚Äî Selecione a P√°gina primeiro ‚Äî</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="margin-top: 12px;">
                <label>Pixel de Rastreamento</label>
                <select id="select-pixel" style="width: 100%;">
                    <option value="">Carregando...</option>
                </select>
            </div>

            <div class="form-group" style="margin-top: 12px;">
                <label>Formul√°rio de Lead <span class="badge badge-blue">PARA CAMPANHAS DE LEADS</span></label>
                <select id="select-leadform" style="width: 100%;">
                    <option value="">‚Äî Selecione a P√°gina primeiro ‚Äî</option>
                </select>
                <div class="card-desc" style="margin-top:4px; font-size:0.85em;">Obrigat√≥rio apenas para campanhas com
                    objetivo de gera√ß√£o de leads.</div>
            </div>
        </div>

        <!-- ================================================================ -->
        <!--  SE√á√ÉO 1: ESTRAT√âGIA                                            -->
        <!-- ================================================================ -->
        <div class="card">
            <div class="card-title">1. Estrat√©gia de Estrutura√ß√£o <span class="badge badge-cyan">OBRIGAT√ìRIO</span>
            </div>
            <div class="card-desc">Escolha como os criativos ser√£o organizados nos conjuntos de an√∫ncios.</div>

            <div class="radio-group">
                <label class="radio-option" id="opt-agrupado" onclick="selecionarEstrategia('agrupado')">
                    <input type="radio" name="estrategia" value="agrupado">
                    <div class="option-icon">üì¶</div>
                    <div class="option-title">Op√ß√£o A ‚Äî Agrupado</div>
                    <div class="option-desc">Todos os criativos sobem dentro do mesmo Conjunto de An√∫ncios.</div>
                </label>
                <label class="radio-option" id="opt-garimpo" onclick="selecionarEstrategia('garimpo')">
                    <input type="radio" name="estrategia" value="garimpo">
                    <div class="option-icon">‚õèÔ∏è</div>
                    <div class="option-title">Op√ß√£o B ‚Äî Garimpo</div>
                    <div class="option-desc">Um Conjunto de An√∫ncios diferente para cada criativo selecionado.</div>
                </label>
            </div>

            <div class="sub-options" id="sub-agrupado">
                <label>Destino do Conjunto</label>
                <div class="sub-radio-group">
                    <label class="sub-radio" id="sub-existente" onclick="selecionarDestino('existente')">
                        <input type="radio" name="destino_conjunto" value="existente"> üìÇ Conjunto Existente
                    </label>
                    <label class="sub-radio" id="sub-duplicar" onclick="selecionarDestino('duplicar')">
                        <input type="radio" name="destino_conjunto" value="duplicar"> üìã Novo (Duplicar)
                    </label>
                </div>
                <div id="select-existente" class="hidden-select">
                    <label>Selecione o Conjunto de An√∫ncios</label>
                    <select name="adset_existente" id="adset_existente">
                        <option value="">‚Äî Selecione ‚Äî</option>
                        {% for adset in adsets %}<option value="{{ adset.id }}">{{ adset.name }}</option>{% endfor %}
                    </select>
                </div>
                <div id="select-duplicar" class="hidden-select">
                    <label>Conjunto modelo para duplica√ß√£o</label>
                    <select name="adset_modelo" id="adset_modelo">
                        <option value="">‚Äî Selecione o molde ‚Äî</option>
                        {% for adset in adsets %}<option value="{{ adset.id }}">{{ adset.name }}</option>{% endfor %}
                    </select>
                    <div class="card-desc" style="margin-top:6px;">O sistema copiar√° p√∫blico, posicionamento e
                        or√ßamento.</div>
                </div>
            </div>

            <div class="sub-options" id="sub-garimpo">
                <label>Conjunto modelo para duplica√ß√£o</label>
                <select name="adset_modelo_garimpo" id="adset_modelo_garimpo">
                    <option value="">‚Äî Selecione o molde ‚Äî</option>
                    {% for adset in adsets %}<option value="{{ adset.id }}">{{ adset.name }}</option>{% endfor %}
                </select>
                <div class="card-desc" style="margin-top:6px;">Cada criativo ganhar√° um novo conjunto baseado neste
                    molde.</div>
            </div>
        </div>

        <!-- ================================================================ -->
        <!--  SE√á√ÉO 2: CONFIGURA√á√ïES GLOBAIS DO LOTE                         -->
        <!-- ================================================================ -->
        <div class="section-label">‚ñº Configura√ß√µes Globais ‚Äî preencha uma vez, vale para todos os criativos ‚ñº</div>

        <div class="card border-purple" id="card-global">
            <div class="card-title">
                2. Configura√ß√µes Globais do Lote
                <span class="badge badge-purple">PREENCHA 1x</span>
                <span class="config-status" id="config-status">‚ö™ Aguardando preenchimento</span>
            </div>
            <div class="card-desc">URL, UTMs, Textos e T√≠tulo ser√£o herdados automaticamente por todos os criativos ao
                subir.</div>

            <label>URL de Destino</label>
            <div class="field-with-history">
                <input type="url" id="url_destino" list="dl-urls" placeholder="https://seusite.com/pagina-destino">
                <button type="button" class="btn-history" onclick="puxarHistorico()"
                    title="Buscar URLs usadas recentemente">üìú Hist√≥rico</button>
            </div>

            <label>Padr√£o de UTMs</label>
            <div class="field-with-history">
                <input type="text" id="utm_pattern" list="dl-utms"
                    placeholder="utm_source=fb&amp;utm_medium=cpc&amp;utm_campaign=nome">
                <button type="button" class="btn-history" onclick="puxarHistorico()"
                    title="Buscar UTMs usadas recentemente">üìú Hist√≥rico</button>
            </div>

            <label>Call to Action (CTA)</label>
            <select id="cta">
                <option value="LEARN_MORE">üìò Saiba Mais (LEARN_MORE)</option>
                <option value="SHOP_NOW">üõí Compre Agora (SHOP_NOW)</option>
                <option value="SIGN_UP">üìù Cadastre-se (SIGN_UP)</option>
                <option value="APPLY_NOW">üì© Inscreva-se (APPLY_NOW)</option>
                <option value="BOOK_TRAVEL">‚úàÔ∏è Reserve (BOOK_TRAVEL)</option>
                <option value="CONTACT_US">üìû Fale Conosco (CONTACT_US)</option>
                <option value="DOWNLOAD">‚¨áÔ∏è Baixar (DOWNLOAD)</option>
                <option value="GET_OFFER">üéÅ Obter Oferta (GET_OFFER)</option>
                <option value="GET_QUOTE">üí¨ Pedir Or√ßamento (GET_QUOTE)</option>
                <option value="ORDER_NOW">üõçÔ∏è Pe√ßa Agora (ORDER_NOW)</option>
                <option value="SUBSCRIBE">üîî Assinar (SUBSCRIBE)</option>
                <option value="WATCH_MORE">‚ñ∂Ô∏è Assistir Mais (WATCH_MORE)</option>
                <option value="SEND_WHATSAPP_MESSAGE">üí¨ WhatsApp (SEND_WHATSAPP_MESSAGE)</option>
                <option value="NO_BUTTON">üö´ Sem Bot√£o (NO_BUTTON)</option>
            </select>

            <!-- Textos Principais -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:18px;">
                <label style="margin:0;">Textos Principais (Primary Text)</label>
                <button type="button" class="btn-history" onclick="puxarHistorico()"
                    title="Buscar textos usados recentemente">üìú Hist√≥rico</button>
            </div>
            <div class="dynamic-fields" id="primary-texts">
                <div class="dynamic-row">
                    <input type="text" name="primary_text[]" list="dl-textos" placeholder="Texto principal #1">
                </div>
            </div>
            <button type="button" class="btn-add"
                onclick="adicionarCampo('primary-texts', 'primary_text[]', 'Texto principal', 'dl-textos')"
                id="btn-add-text">+ Adicionar varia√ß√£o</button>
            <div class="field-counter" id="counter-text">1 de 5 varia√ß√µes</div>

            <!-- T√≠tulos -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:18px;">
                <label style="margin:0;">T√≠tulos (Headline)</label>
                <button type="button" class="btn-history" onclick="puxarHistorico()"
                    title="Buscar t√≠tulos usados recentemente">üìú Hist√≥rico</button>
            </div>
            <div class="dynamic-fields" id="headlines">
                <div class="dynamic-row">
                    <input type="text" name="headline[]" list="dl-titulos" placeholder="T√≠tulo #1">
                </div>
            </div>
            <button type="button" class="btn-add"
                onclick="adicionarCampo('headlines', 'headline[]', 'T√≠tulo', 'dl-titulos')" id="btn-add-headline">+
                Adicionar varia√ß√£o</button>
            <div class="field-counter" id="counter-headline">1 de 5 varia√ß√µes</div>

            <div class="warning-box">
                <div class="warn-icon">‚ö†Ô∏è</div>
                <p><strong>Advantage+ Desativado:</strong> standard_enhancements ser√° desativado. Voc√™ ter√° controle
                    total.</p>
            </div>
        </div>

        <!-- ================================================================ -->
        <!--  SE√á√ÉO 3: ADI√á√ÉO R√ÅPIDA DE M√çDIA                               -->
        <!-- ================================================================ -->
        <div class="section-label">‚ñº Adicione as m√≠dias ‚Äî cada par vira um an√∫ncio na fila ‚ñº</div>

        <div class="card border-green">
            <div class="card-title">
                3. Adicionar Criativos √† Fila
                <span class="badge badge-green">MULTI-UPLOAD</span>
            </div>
            <div class="card-desc">Selecione as m√≠dias (Feed + Stories). Configura√ß√µes globais s√£o herdadas no momento
                do envio.</div>

            <!-- NOVO: Importa√ß√£o via Pasta do Drive -->
            <div class="drive-folder-import">
                <div class="form-group">
                    <label>üîó link da Pasta do Google Drive (P√∫blica)</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="url" id="drive-folder-url" placeholder="https://drive.google.com/drive/folders/..."
                            style="flex: 1;">
                        <button type="button" class="btn-history" onclick="importarPastaDrive()">üì• Capturar
                            Pasta</button>
                    </div>
                    <div class="card-desc" style="margin-top: 5px; font-size: 0.8em;">
                        Arquivos devem ter o mesmo nome inicial, terminando em <b>_FEED</b> ou <b>_REELS</b> (Ex:
                        <i>Ad01_FEED.mp4</i> e <i>Ad01_REELS.mp4</i>).
                    </div>
                </div>
            </div>

            <div class="upload-pair">
                <div class="upload-box" id="box-feed">
                    <div class="upload-icon">üñºÔ∏è</div>
                    <div class="upload-label">Feed / Square</div>
                    <div class="upload-hint">1:1 ou 4:5 ¬∑ Imagem ou V√≠deo</div>

                    <input type="file" id="arquivo_feed" accept="image/*,video/*"
                        onchange="previewFile(this, 'preview-feed')">

                    <div class="upload-options">
                        <div class="upload-separator">‚Äî OU USE LINK (GOOGLE DRIVE) ‚Äî</div>
                        <input type="url" id="url_feed_remote" placeholder="https://drive.google.com/..."
                            class="input-url-remote" oninput="validarInputMidia('feed')">
                    </div>

                    <div class="file-preview" id="preview-feed"></div>
                </div>
                <div class="upload-box" id="box-stories">
                    <div class="upload-icon">üì±</div>
                    <div class="upload-label">Stories / Reels</div>
                    <div class="upload-hint">9:16 ¬∑ Imagem ou V√≠deo</div>

                    <input type="file" id="arquivo_stories" accept="image/*,video/*"
                        onchange="previewFile(this, 'preview-stories')">

                    <div class="upload-options">
                        <div class="upload-separator">‚Äî OU USE LINK (GOOGLE DRIVE) ‚Äî</div>
                        <input type="url" id="url_stories_remote" placeholder="https://drive.google.com/..."
                            class="input-url-remote" oninput="validarInputMidia('stories')">
                    </div>

                    <div class="file-preview" id="preview-stories"></div>
                </div>
            </div>

            <!-- Warning Box for Cropping -->
            <div id="warning-crop" class="warning-box"
                style="display:none; margin: 15px 0; background-color: #fff3cd; border-left: 4px solid #ffc107; color: #856404; padding: 12px;">
                <div class="warn-icon" style="margin-right: 10px; font-size: 1.2em;">‚ö†Ô∏è</div>
                <p style="margin: 0; font-size: 0.95em;"><strong>Aten√ß√£o ao Formato:</strong> Voc√™ forneceu apenas a
                    vers√£o vertical (Stories/9:16).<br>
                    Ao aparecer no Feed, a imagem poder√° ser cortada ou exibida com faixas laterais. Recomendamos subir
                    tamb√©m uma vers√£o 1:1.</p>
            </div>

            <button type="button" class="btn-add-to-queue" onclick="adicionarNaFila()">
                üì• Adicionar √† Fila
            </button>
        </div>

        <!-- ================================================================ -->
        <!--  FILA DE UPLOAD                                                 -->
        <!-- ================================================================ -->
        <div style="margin-bottom: 24px;">
            <div class="queue-header">
                <h3>üìã Fila de Upload</h3>
                <span class="queue-counter" id="queue-counter">0 an√∫ncios</span>
            </div>

            <div id="queue-list">
                <div class="queue-empty" id="queue-empty">
                    Nenhum an√∫ncio na fila.<br>Adicione m√≠dias na se√ß√£o acima.
                </div>
            </div>

            <div id="queue-actions" style="display:none;">
                <button type="button" class="btn-submit-all" id="btn-submit-all" onclick="subirTodos()">
                    üöÄ Subir Todos os An√∫ncios
                </button>
                <div class="footer-note">Todos os an√∫ncios ser√£o criados com status <strong>PAUSED</strong>.</div>

                <!-- Log Console -->
                <div class="log-console" id="log-console" style="display:none;">
                    <div class="log-console-header">
                        <span>üìü Console de Opera√ß√µes</span>
                        <span class="log-console-dot" id="log-dot"></span>
                    </div>
                    <div class="log-console-body" id="log-body">
                        <div class="log-console-empty">Aguardando in√≠cio do upload...</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="toast" id="toast"></div>

    <style>
        .upload-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .upload-separator {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: bold;
            letter-spacing: 1px;
        }

        .input-url-remote {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 12px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .input-url-remote:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .badge-link {
            background: var(--primary);
            color: black;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 5px;
        }
    </style>

    <script>
        const CAMPAIGN_ID = "{{ campaign_id }}";
        const ACCOUNT_ID = "{{ account_id }}";
        const filaAnuncios = [];
        let historicoCarregado = false;

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ======================== IDENTITY & TRACKING ========================
        async function carregarIdentidade() {
            try {
                const resp = await fetch(`/api/conta/${ACCOUNT_ID}/identity`);
                const data = await resp.json();

                if (data.error) {
                    console.error('‚ùå Identity error:', data.error);
                    mostrarToast('‚ö†Ô∏è Erro: ' + data.error);
                    return;
                }

                const { pages, instagrams, pixels } = data;

                // P√°ginas
                const selPage = document.getElementById('select-page');
                if (Array.isArray(pages) && pages.length > 0) {
                    selPage.innerHTML = '<option value="">‚Äî Selecione a P√°gina ‚Äî</option>';
                    pages.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.name;
                        selPage.appendChild(opt);
                    });
                } else {
                    selPage.innerHTML = '<option value="">‚ö†Ô∏è Nenhuma p√°gina encontrada</option>';
                }

                // Instagrams
                const selIg = document.getElementById('select-instagram');
                if (Array.isArray(instagrams) && instagrams.length > 0) {
                    selIg.innerHTML = '<option value="">‚Äî Selecione o Instagram ‚Äî</option>';
                    instagrams.forEach(ig => {
                        const opt = document.createElement('option');
                        opt.value = ig.id;
                        opt.textContent = `@${ig.username}`;
                        selIg.appendChild(opt);
                    });
                } else {
                    selIg.innerHTML = '<option value="">‚ö†Ô∏è Nenhum Instagram vinculado</option>';
                }

                // Pixels
                const selPixel = document.getElementById('select-pixel');
                selPixel.innerHTML = '<option value="">‚Äî Selecione o Pixel (Recomendado) ‚Äî</option>';
                if (Array.isArray(pixels)) {
                    pixels.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.name;
                        selPixel.appendChild(opt);
                    });
                }

                console.log(`‚ö° Identidade carregada: ${pages?.length || 0} p√°ginas, ${instagrams?.length || 0} IGs, ${pixels?.length || 0} pixels`);

                // Listener para carregar Lead Forms quando p√°gina muda
                selPage.addEventListener('change', () => carregarLeadForms(selPage.value));

            } catch (e) {
                console.error('‚ùå Erro em carregarIdentidade:', e);
                mostrarToast('‚ö†Ô∏è Erro ao carregar dados de identidade');
            }
        }

        async function carregarLeadForms(pageId) {
            const sel = document.getElementById('select-leadform');
            if (!pageId) {
                sel.innerHTML = '<option value="">‚Äî Selecione a P√°gina primeiro ‚Äî</option>';
                return;
            }
            sel.innerHTML = '<option value="">Carregando formul√°rios...</option>';
            try {
                const resp = await fetch(`/api/pagina/${pageId}/leadgen_forms`);
                const data = await resp.json();
                if (data.error) {
                    sel.innerHTML = '<option value="">‚ö†Ô∏è Erro ao carregar</option>';
                    return;
                }
                const forms = data.forms || [];
                if (forms.length === 0) {
                    sel.innerHTML = '<option value="">‚Äî Nenhum formul√°rio encontrado ‚Äî</option>';
                } else {
                    sel.innerHTML = '<option value="">‚Äî Sem formul√°rio (opcional) ‚Äî</option>';
                    forms.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = f.id;
                        opt.textContent = `üìã ${f.name} (${f.status})`;
                        sel.appendChild(opt);
                    });
                }
                console.log(`üìã ${forms.length} Lead Forms carregados`);
            } catch (e) {
                sel.innerHTML = '<option value="">‚ö†Ô∏è Erro de conex√£o</option>';
                console.error('‚ùå Erro em carregarLeadForms:', e);
            }
        }

        // Call on load
        window.addEventListener('DOMContentLoaded', carregarIdentidade);

        // ======================== STRATEGY ========================
        function selecionarEstrategia(tipo) {
            document.querySelectorAll('.radio-option').forEach(el => el.classList.remove('selected'));
            document.getElementById('opt-' + tipo).classList.add('selected');
            document.querySelector(`input[name="estrategia"][value="${tipo}"]`).checked = true;
            document.getElementById('sub-agrupado').classList.toggle('visible', tipo === 'agrupado');
            document.getElementById('sub-garimpo').classList.toggle('visible', tipo === 'garimpo');
            if (tipo === 'garimpo') {
                document.querySelectorAll('.sub-radio').forEach(el => el.classList.remove('selected'));
                document.getElementById('select-existente').classList.add('hidden-select');
                document.getElementById('select-duplicar').classList.add('hidden-select');
            }
        }

        function selecionarDestino(tipo) {
            document.querySelectorAll('.sub-radio').forEach(el => el.classList.remove('selected'));
            document.getElementById('sub-' + tipo).classList.add('selected');
            document.querySelector(`input[name="destino_conjunto"][value="${tipo}"]`).checked = true;
            document.getElementById('select-existente').classList.toggle('hidden-select', tipo !== 'existente');
            document.getElementById('select-duplicar').classList.toggle('hidden-select', tipo !== 'duplicar');
        }

        // ======================== DYNAMIC FIELDS ========================
        const maxVariacoes = 5;

        function adicionarCampo(containerId, fieldName, placeholder, datalistId) {
            const container = document.getElementById(containerId);
            const count = container.querySelectorAll('.dynamic-row').length;
            if (count >= maxVariacoes) return;
            const row = document.createElement('div');
            row.className = 'dynamic-row';
            row.innerHTML = `
                <input type="text" name="${fieldName}" list="${datalistId || ''}" placeholder="${placeholder} #${count + 1}">
                <button type="button" class="btn-remove" onclick="removerCampo(this, '${containerId}')">√ó</button>
            `;
            container.appendChild(row);
            atualizarContador(containerId);
        }

        function removerCampo(btn, containerId) {
            const container = document.getElementById(containerId);
            if (container.querySelectorAll('.dynamic-row').length > 1) {
                btn.parentElement.remove();
                atualizarContador(containerId);
            }
        }

        function atualizarContador(containerId) {
            const container = document.getElementById(containerId);
            const count = container.querySelectorAll('.dynamic-row').length;
            const isText = containerId === 'primary-texts';
            document.getElementById(isText ? 'counter-text' : 'counter-headline').textContent = `${count} de ${maxVariacoes} varia√ß√µes`;
            document.getElementById(isText ? 'btn-add-text' : 'btn-add-headline').disabled = count >= maxVariacoes;
        }

        // ======================== FILE PREVIEW ========================
        function previewFile(input, previewId) {
            const preview = document.getElementById(previewId);
            const box = input.closest('.upload-box');
            const type = previewId.includes('feed') ? 'feed' : 'stories';
            const urlInput = document.getElementById(`url_${type}_remote`);

            if (input.files.length > 0) {
                preview.textContent = 'üìé ' + input.files[0].name;
                preview.style.display = 'block';
                box.style.borderColor = 'var(--success)';
                if (urlInput) urlInput.value = ''; // Limpa URL se subir arquivo
            } else {
                if (!urlInput || !urlInput.value) {
                    preview.style.display = 'none';
                    box.style.borderColor = '';
                }
            }
        }

        function validarInputMidia(type) {
            const urlInput = document.getElementById(`url_${type}_remote`);
            const fileInput = document.getElementById(`arquivo_${type}`);
            const box = document.getElementById(`box-${type}`);
            const preview = document.getElementById(`preview-${type}`);

            if (urlInput.value.trim().length > 10) {
                box.style.borderColor = 'var(--success)';
                preview.textContent = 'üîó Link detectado';
                preview.style.display = 'block';
                if (fileInput) fileInput.value = ''; // Limpa arquivo se colar URL
            } else {
                if (!fileInput.files.length) {
                    box.style.borderColor = '';
                    preview.style.display = 'none';
                }
            }
        }

        // ======================== HISTORY / AUTOCOMPLETE ========================
        async function puxarHistorico() {
            if (historicoCarregado) { mostrarToast('‚úÖ Hist√≥rico j√° carregado!'); return; }
            document.querySelectorAll('.btn-history').forEach(b => { b.textContent = '‚è≥...'; b.disabled = true; });

            try {
                const resp = await fetch(`/api/campanha/${CAMPAIGN_ID}/historico_textos`);
                const data = await resp.json();
                if (data.error) { mostrarToast('‚ùå ' + data.error); return; }

                preencherDatalist('dl-urls', data.urls || []);
                preencherDatalist('dl-utms', data.utms || []);
                preencherDatalist('dl-textos', data.textos || []);
                preencherDatalist('dl-titulos', data.titulos || []);
                historicoCarregado = true;

                document.querySelectorAll('.btn-history').forEach(b => {
                    b.textContent = '‚úÖ Carregado'; b.classList.add('loaded'); b.disabled = false;
                });
                const total = (data.urls?.length || 0) + (data.textos?.length || 0) + (data.titulos?.length || 0);
                mostrarToast(`üìú ${total} sugest√µes carregadas`);
            } catch (e) {
                mostrarToast('‚ùå Erro ao buscar hist√≥rico');
                document.querySelectorAll('.btn-history').forEach(b => { b.textContent = 'üìú Hist√≥rico'; b.disabled = false; });
            }
        }

        function preencherDatalist(id, valores) {
            const dl = document.getElementById(id);
            dl.innerHTML = '';
            valores.forEach(v => { const o = document.createElement('option'); o.value = v; dl.appendChild(o); });
        }

        // ======================== GOOGLE DRIVE FOLDER IMPORT ========================
        async function importarPastaDrive() {
            const url = document.getElementById('drive-folder-url').value.trim();
            if (!url || !url.includes('drive.google.com')) {
                mostrarToast('‚ùå Link de pasta inv√°lido');
                return;
            }

            logConsole(`üìÅ Iniciando captura da pasta do Drive...`, 'log-info');
            mostrarToast('‚è≥ Escaneando pasta... Isso pode levar alguns segundos.');

            try {
                const resp = await fetch('/api/drive/list_folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await resp.json();

                if (data.error) {
                    logConsole(`‚ùå Erro ao capturar pasta: ${data.error}`, 'log-error');
                    mostrarToast('‚ö†Ô∏è Erro: ' + data.error);
                    return;
                }

                const pares = data.pares || [];
                if (pares.length === 0) {
                    logConsole(`‚ö†Ô∏è Nenhum par de criativos (FEED/REELS) encontrado na pasta.`, 'log-warning');
                    mostrarToast('‚ö†Ô∏è Nenhum par compat√≠vel encontrado');
                    return;
                }

                pares.forEach(p => {
                    const item = {
                        id: Date.now() + Math.random(),
                        adName: p.nome,
                        feedFile: null,
                        storiesFile: null,
                        feedFileName: p.feed_name || 'Link Remoto',
                        storiesFileName: p.reels_name || 'Link Remoto',
                        urlFeed: p.feed_url,
                        urlStories: p.reels_url,
                    };
                    filaAnuncios.push(item);
                });

                renderizarFila();
                logConsole(`‚úÖ ${pares.length} pares capturados com sucesso!`, 'log-success');
                mostrarToast(`üéâ ${pares.length} criativos adicionados √† fila!`);
                document.getElementById('drive-folder-url').value = '';

            } catch (e) {
                console.error('‚ùå Erro drive:', e);
                logConsole(`‚ùå Erro de conex√£o ao capturar pasta.`, 'log-error');
            }
        }
        function lerConfigGlobal() {
            const url = document.getElementById('url_destino').value.trim();
            const utms = document.getElementById('utm_pattern').value.trim();
            const cta = document.getElementById('cta').value;
            const textos = [];
            document.querySelectorAll('#primary-texts input').forEach(i => { if (i.value.trim()) textos.push(i.value.trim()); });
            const titulos = [];
            document.querySelectorAll('#headlines input').forEach(i => { if (i.value.trim()) titulos.push(i.value.trim()); });
            return { url, utms, cta, textos, titulos };
        }

        function atualizarStatusConfig() {
            const cfg = lerConfigGlobal();
            const el = document.getElementById('config-status');
            if (cfg.url) {
                el.textContent = 'üü¢ Configura√ß√µes preenchidas';
                el.className = 'config-status active';
            } else {
                el.textContent = '‚ö™ Aguardando preenchimento';
                el.className = 'config-status';
            }
        }

        document.getElementById('card-global').addEventListener('input', atualizarStatusConfig);
        document.getElementById('cta').addEventListener('change', atualizarStatusConfig);

        // ======================== THUMBNAIL GENERATOR ========================
        function gerarThumbnailURL(file) {
            if (!file) return null;
            return URL.createObjectURL(file);
        }

        function isVideo(file) {
            return file && file.type.startsWith('video/');
        }

        function criarThumbnailHTML(file) {
            if (!file) return '<div class="queue-thumb"><span class="thumb-placeholder">‚Äî</span></div>';
            const url = gerarThumbnailURL(file);
            if (isVideo(file)) {
                return `<div class="queue-thumb"><video src="${url}" preload="metadata" muted></video></div>`;
            } else {
                return `<div class="queue-thumb"><img src="${url}" alt="preview"></div>`;
            }
        }

        // ======================== QUEUE ========================
        function adicionarNaFila() {
            const feedInput = document.getElementById('arquivo_feed');
            const storiesInput = document.getElementById('arquivo_stories');
            const urlFeedRemote = document.getElementById('url_feed_remote').value.trim();
            const urlStoriesRemote = document.getElementById('url_stories_remote').value.trim();

            if (!feedInput.files.length && !storiesInput.files.length && !urlFeedRemote && !urlStoriesRemote) {
                mostrarToast('‚ùå Selecione pelo menos um arquivo de m√≠dia ou forne√ßa um link remoto');
                return;
            }

            let adName = '';
            if (feedInput.files.length) {
                adName = feedInput.files[0].name.replace(/\.[^/.]+$/, '');
            } else if (storiesInput.files.length) {
                adName = storiesInput.files[0].name.replace(/\.[^/.]+$/, '');
            } else if (urlFeedRemote) {
                adName = urlFeedRemote.substring(urlFeedRemote.lastIndexOf('/') + 1);
            } else if (urlStoriesRemote) {
                adName = urlStoriesRemote.substring(urlStoriesRemote.lastIndexOf('/') + 1);
            }
            adName = adName || `An√∫ncio ${filaAnuncios.length + 1}`;


            const item = {
                id: Date.now(),
                adName,
                feedFile: feedInput.files[0] || null,
                storiesFile: storiesInput.files[0] || null,
                feedFileName: feedInput.files[0]?.name || null,
                storiesFileName: storiesInput.files[0]?.name || null,
                urlFeed: urlFeedRemote,
                urlStories: urlStoriesRemote,
            };

            filaAnuncios.push(item);
            renderizarFila();

            feedInput.value = '';
            storiesInput.value = '';
            document.getElementById('url_feed_remote').value = '';
            document.getElementById('url_stories_remote').value = '';
            document.getElementById('preview-feed').style.display = 'none';
            document.getElementById('preview-stories').style.display = 'none';
            document.getElementById('box-feed').style.borderColor = '';
            document.getElementById('box-stories').style.borderColor = '';
            verificarAvisoCorte();

            mostrarToast(`‚úÖ "${adName}" adicionado √† fila (#${filaAnuncios.length})`);
        }

        function removerDaFila(id) {
            const idx = filaAnuncios.findIndex(i => i.id === id);
            if (idx > -1) {
                const nome = filaAnuncios[idx].adName;
                filaAnuncios.splice(idx, 1);
                renderizarFila();
                mostrarToast(`üóëÔ∏è "${nome}" removido`);
            }
        }

        function atualizarNomeFila(id, novo) {
            const item = filaAnuncios.find(i => i.id === id);
            if (item) item.adName = novo;
        }

        function renderizarFila() {
            const list = document.getElementById('queue-list');
            const empty = document.getElementById('queue-empty');
            const actions = document.getElementById('queue-actions');
            const counter = document.getElementById('queue-counter');

            counter.textContent = `${filaAnuncios.length} an√∫ncio${filaAnuncios.length !== 1 ? 's' : ''}`;
            list.querySelectorAll('.queue-item').forEach(el => el.remove());

            if (filaAnuncios.length === 0) {
                empty.style.display = 'block';
                actions.style.display = 'none';
                return;
            }

            empty.style.display = 'none';
            actions.style.display = 'block';

            filaAnuncios.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'queue-item';

                const thumbFile = item.feedFile || item.storiesFile;
                const thumbHTML = criarThumbnailHTML(thumbFile);

                div.innerHTML = `
                    <div class="queue-item-number">${idx + 1}</div>
                    ${thumbHTML}
                    <div class="queue-item-body">
                        <input class="queue-item-name" type="text" value="${escapeHtml(item.adName)}"
                            onchange="atualizarNomeFila(${item.id}, this.value)"
                            title="Edite o nome do an√∫ncio">
                        <div class="queue-item-files">
                            ${item.feedFileName ? `<span class="queue-file-tag">üñºÔ∏è ${item.feedFileName}</span>` : ''}
                            ${item.urlFeed ? '<span class="badge-link">üîó FEED LINK</span>' : ''}
                            ${item.storiesFileName ? `<span class="queue-file-tag">üì± ${item.storiesFileName}</span>` : ''}
                            ${item.urlStories ? '<span class="badge-link">üîó STORY LINK</span>' : ''}
                        </div>
                    </div>
                    <button class="btn-queue-remove" onclick="removerDaFila(${item.id})">‚úï</button>
                `;
                list.appendChild(div);
            });
        }

        // ======================== LOG CONSOLE ========================
        function logConsole(msg, type = '') {
            const console = document.getElementById('log-console');
            const body = document.getElementById('log-body');
            const dot = document.getElementById('log-dot');

            console.style.display = 'block';
            dot.classList.add('active');

            // Remove empty placeholder
            const placeholder = body.querySelector('.log-console-empty');
            if (placeholder) placeholder.remove();

            const now = new Date();
            const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${escapeHtml(msg)}`;
            body.appendChild(entry);

            // Auto-scroll
            const consoleEl = document.getElementById('log-console');
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function logStop() {
            document.getElementById('log-dot').classList.remove('active');
        }

        function classifyLog(msg) {
            if (msg.includes('‚úÖ') || msg.includes('üèÅ')) return 'log-success';
            if (msg.includes('‚ùå')) return 'log-error';
            if (msg.includes('‚ö†Ô∏è') || msg.includes('‚è∏Ô∏è')) return 'log-warning';
            if (msg.includes('üì§') || msg.includes('üé®') || msg.includes('üìå') || msg.includes('üöÄ')) return 'log-info';
            return '';
        }

        // ======================== SUBMIT ALL ========================
        async function subirTodos() {
            if (filaAnuncios.length === 0) return;

            const cfg = lerConfigGlobal();
            if (!cfg.url) { mostrarToast('‚ùå Preencha a URL de destino antes de subir'); return; }

            const estrategia = document.querySelector('input[name="estrategia"]:checked');
            if (!estrategia) { mostrarToast('‚ùå Selecione uma estrat√©gia de estrutura√ß√£o'); return; }

            const btn = document.getElementById('btn-submit-all');
            btn.disabled = true;

            const destino = document.querySelector('input[name="destino_conjunto"]:checked')?.value;
            const adsetExistente = document.getElementById('adset_existente')?.value;
            const adsetModelo = document.getElementById('adset_modelo')?.value;
            const adsetModeloGarimpo = document.getElementById('adset_modelo_garimpo')?.value;

            // Start log console
            logConsole(`üöÄ Lote iniciado ‚Äî ${filaAnuncios.length} an√∫ncio(s) na fila`, 'log-info');

            let enviados = 0, erros = 0;

            for (let i = 0; i < filaAnuncios.length; i++) {
                const item = filaAnuncios[i];
                btn.textContent = `‚è≥ Enviando ${i + 1}/${filaAnuncios.length}...`;

                logConsole(`üì¶ Processando ${i + 1}/${filaAnuncios.length}: "${item.adName}"`, 'log-info');

                const fd = new FormData();
                fd.append('estrategia', estrategia.value);
                fd.append('destino_conjunto', destino || '');
                fd.append('adset_existente', adsetExistente || '');
                fd.append('adset_modelo', adsetModelo || adsetModeloGarimpo || '');
                fd.append('ad_name', item.adName);
                fd.append('url_destino', cfg.url);
                fd.append('utm_pattern', cfg.utms);
                fd.append('cta', cfg.cta);
                cfg.textos.forEach(t => fd.append('primary_text[]', t));
                cfg.titulos.forEach(t => fd.append('headline[]', t));

                if (item.feedFile) fd.append('arquivo_feed', item.feedFile);
                if (item.storiesFile) fd.append('arquivo_stories', item.storiesFile);
                if (item.urlFeed) fd.append('url_feed_remote', item.urlFeed);
                if (item.urlStories) fd.append('url_stories_remote', item.urlStories);

                // Identity & Tracking
                const pageId = document.getElementById('select-page').value;
                if (!pageId) { mostrarToast('‚ùå Selecione a P√°gina do Facebook!'); return; }
                fd.append('page_id', pageId);
                const igVal = document.getElementById('select-instagram').value;
                if (igVal) fd.append('instagram_actor_id', igVal);
                const pixelVal = document.getElementById('select-pixel').value;
                if (pixelVal) fd.append('pixel_id', pixelVal);
                const leadFormVal = document.getElementById('select-leadform').value;
                if (leadFormVal) fd.append('lead_gen_form_id', leadFormVal);

                try {
                    logConsole(`üì§ Fazendo upload de "${item.adName}"...`, 'log-info');

                    const r = await fetch(`/campanha/${CAMPAIGN_ID}/upload`, { method: 'POST', body: fd });
                    const text = await r.text();
                    let res;
                    try {
                        res = JSON.parse(text);
                    } catch (e) {
                        erros++;
                        logConsole(`‚ùå Erro do Servidor (500/Timeout): Resposta inv√°lida.`, 'log-error');
                        console.error('Resposta n√£o-JSON:', text);
                        continue;
                    }

                    if (res.success) {
                        enviados++;
                        logConsole(`‚úÖ "${item.adName}" criado com sucesso ‚Äî ID: ${res.ad_id}`, 'log-success');
                    } else {
                        erros++;
                        logConsole(`‚ùå "${item.adName}" falhou: ${res.error}`, 'log-error');
                    }

                    if (res.logs) {
                        res.logs.forEach(l => logConsole(l, classifyLog(l)));
                    }

                    if (i < filaAnuncios.length - 1) {
                        logConsole(`‚è≥ Aguardando delay de seguran√ßa...`);
                    }

                } catch (e) {
                    erros++;
                    logConsole(`‚ùå Erro de rede: ${e.message}`, 'log-error');
                }
            } // Fim do Loop For

            btn.disabled = false;
            btn.textContent = 'üöÄ Subir Todos os An√∫ncios';

            logConsole(`üèÅ Lote conclu√≠do: ${enviados} ‚úÖ sucesso, ${erros} ‚ùå erro(s)`, enviados > 0 ? 'log-success' : 'log-error');
            logStop();

            if (erros === 0) {
                mostrarToast(`üéâ ${enviados} an√∫ncio(s) enviados com sucesso!`);
                filaAnuncios.length = 0;
                renderizarFila();
            } else {
                mostrarToast(`‚ö†Ô∏è ${enviados} OK, ${erros} com erro`);
            }
        }

        // ======================== UTILS ========================
        function mostrarToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3500);
        }

        // ======================== CROSS CHECK / WARNINGS ========================
        function verificarAvisoCorte() {
            const feedInput = document.getElementById('arquivo_feed');
            const storiesInput = document.getElementById('arquivo_stories');
            const warning = document.getElementById('warning-crop');

            const hasFeed = feedInput.files && feedInput.files.length > 0;
            const hasStories = storiesInput.files && storiesInput.files.length > 0;

            // Condi√ß√£o: Tem Stories MAS N√ÉO TEM Feed
            if (hasStories && !hasFeed) {
                warning.style.display = 'flex';
            } else {
                warning.style.display = 'none';
            }
        }

        // Attach listeners
        document.getElementById('arquivo_feed').addEventListener('change', verificarAvisoCorte);
        document.getElementById('arquivo_stories').addEventListener('change', verificarAvisoCorte);

    </script>


</body>

</html>