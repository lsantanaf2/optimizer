# v1.6.2 Deployment Guide

**Data**: 2026-02-21
**Status**: Ready for VPS deployment
**Commits**:
- d8feff9: fix: v1.6.2 - resiliÃªncia de upload com urllib3.Retry + timeouts ajustados
- 1f754ec: chore: v1.6.2 - versÃ£o bump

---

## ğŸ¯ O Que Foi Corrigido

### Problema
Erros recorrentes ao fazer upload de vÃ­deos (4Âª tentativa):
```
SSLError: UNEXPECTED_EOF_WHILE_READING
RemoteDisconnected: Remote end closed connection without response
HTTPSConnectionPool: Max retries exceeded
```

### Causa Root
`meta_api.py` usava `requests` sem configuraÃ§Ã£o de retry automÃ¡tico na camada de socket.

---

## âœ… SoluÃ§Ã£o Implementada

### 1. **urllib3.Retry + HTTPAdapter**
- Retry automÃ¡tico a nÃ­vel de socket (3 tentativas)
- Backoff exponencial: 1s â†’ 2s â†’ 4s
- Reutiliza pool de conexÃµes
- Reconecta em SSL errors, timeouts, connection resets

**CÃ³digo**:
```python
def _get_session(self):
    """Session com retry automÃ¡tico"""
    retry_strategy = Retry(
        total=3,
        backoff_factor=1.0,
        status_forcelist=[429, 500, 502, 503, 504],
        allowed_methods=["HEAD", "GET", "OPTIONS", "POST", "PUT", "DELETE"]
    )
    adapter = HTTPAdapter(max_retries=retry_strategy)
    session.mount("https://", adapter)
    session.mount("http://", adapter)
    return session
```

### 2. **Delays Maiores Entre Uploads**
- `DELAY_MIN`: 1.5s â†’ **3.0s**
- `DELAY_MAX`: 3.0s â†’ **6.0s**
- `DELAY_VIDEO_MIN`: **5.0s** (novo)
- `DELAY_VIDEO_MAX`: **10.0s** (novo)

**Efeito**: Reduz agressividade, respeita rate limit preventivamente

### 3. **Timeouts Ajustados**
```python
TIMEOUT_API_GET = 30          # Metadata
TIMEOUT_API_POST = 60         # CriaÃ§Ã£o de criativo/ad
TIMEOUT_UPLOAD_VIDEO = 600    # 10 minutos (vÃ­deos grandes!)
TIMEOUT_DOWNLOAD = 120        # 2 minutos (Drive)
```

---

## ğŸ“ MudanÃ§as em `meta_api.py`

| FunÃ§Ã£o | MudanÃ§a |
|--------|---------|
| `_get_session()` | **Nova** â€” retorna Session com Retry configurado |
| `upload_image_url()` | Usa `self._get_session().post()` + timeout |
| `upload_video_url()` | Usa `self._get_session().post(timeout=600)` |
| `upload_video()` | Adiciona `video_delay()` apÃ³s sucesso |
| `_download_file()` | Usa `self._get_session()` reutilizÃ¡vel |
| `wait_for_video_ready()` | Usa `self._get_session().get()` + timeout |
| `wait_for_image_ready()` | Usa `self._get_session().get()` + timeout |
| `create_creative_with_placements()` | Usa `self._get_session().post()` + timeout |
| `create_ad()` | Usa `self._get_session().post()` + timeout |
| `duplicate_adset()` | Usa `self._get_session().post()` + timeout |

---

## ğŸš€ VPS Deployment Commands

```bash
cd /var/www/optimizer

# 1. Atualizar cÃ³digo
git pull origin main

# 2. Build da imagem Docker
docker build -t optimizer-image:auto .

# 3. Remover container antigo
docker rm -f meta-optimizer-sniper || true

# 4. Rodar novo container
docker run -d --name meta-optimizer-sniper -p 5000:5000 \
  -e APP_ID="1346057000583645" \
  -e APP_SECRET="75c24875c00b19c329984b838aac35de" \
  -e REDIRECT_URI="https://optimizer.xn--trfego-qta.com/callback" \
  --restart always optimizer-image:auto

# 5. Verificar status
docker ps | grep meta-optimizer-sniper
docker logs meta-optimizer-sniper
```

---

## âœ¨ Resultado Esperado

- âœ… EliminaÃ§Ã£o de SSL/UNEXPECTED_EOF_WHILE_READING errors
- âœ… Sem mais RemoteDisconnected errors
- âœ… Uploads de vÃ­deo muito mais estÃ¡veis
- âœ… VPS mais resiliente sob carga

---

## ğŸ§ª Teste de ValidaÃ§Ã£o

ApÃ³s deployment:
1. Acesse: https://optimizer.xn--trfego-qta.com
2. FaÃ§a upload de um vÃ­deo (especialmente vÃ­deos grandes > 10MB)
3. Deve completar sem erros SSL
4. Se falhar, cole logs de: `docker logs meta-optimizer-sniper`

---

## ğŸ“Š VersÃ£o

- **v1.6.2**: SSL/connection resilience via urllib3.Retry + video delay
- **Anterior**: v1.6.1 (finalizing version bump)
- **PrÃ³xima**: TBD

---

## ğŸ” Debug (se necessÃ¡rio)

```bash
# Ver logs em tempo real
docker logs -f meta-optimizer-sniper

# Acessar container
docker exec -it meta-optimizer-sniper bash

# Checar porta 5000
netstat -tlnp | grep 5000

# Restart do container
docker restart meta-optimizer-sniper
```

---

**Deploy realizado em**: 2026-02-21
**Status**: âœ… Ready
**Tested**: Syntax check passed
